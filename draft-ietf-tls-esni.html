<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>TLS Encrypted Client Hello</title>
<meta content="Eric Rescorla" name="author">
<meta content="Kazuho Oku" name="author">
<meta content="Nick Sullivan" name="author">
<meta content="Christopher A. Wood" name="author">
<meta content="
       This document describes a mechanism in Transport Layer Security (TLS) for
encrypting a ClientHello message under a server public key. 
    " name="description">
<meta content="xml2rfc 3.27.0" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-ietf-tls-esni-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.27.0
    Python 3.12.9
    ConfigArgParse 1.7
    google-i18n-address 3.1.1
    intervaltree 3.1.0
    Jinja2 3.1.5
    lxml 5.3.0
    platformdirs 4.3.6
    pycountry 24.6.1
    PyYAML 6.0.2
    requests 2.32.3
    setuptools 70.3.0
    wcwidth 0.2.13
-->
<link href="draft-ietf-tls-esni.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-cyrillic.woff2') format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-greek.woff2') format('woff2');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-greek.woff2') format('woff2');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  --font-title: "Sofia Sans Semi Condensed", sans-serif;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
section {
  clear: both;
}
.section-number {
  padding-right: 0.5em;
}
h1, h2, h3, h4, h5, h6 {
  font-family: var(--font-title);
  font-weight: 680;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
  vertical-align: top;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
  & :is(ol, ul) {
    margin-left: 1em;
  }
}
li {
  margin: 0 0 0.25em 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
  & li {
    margin-top: 0.5em;
  }
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  margin: 0 0 0 2em;
  & li {
    margin: 0;
    & :first-child { margin-top: 0; }
    & :last-child { margin-bottom: 0; }
  }
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
  &.olPercent {
    --indent: 5ch;
    & > dt {
      min-width: calc(var(--indent) - 2ch);
    }
  }
  &.olPercent > dt {
    float: none;
  }

  dl > dd > & {
    margin-top: 0.5em;
    margin-bottom: 0;
  }
}
dl:not(.dlNewline) > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
  & > :is(:first-child, .break:first-child + *) {
    margin-top: 0;
  }
  & > :is(:last-child) {
    margin-bottom: 0;
  }
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
  caption-side: bottom;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    /* In the horizontal direction, sometimes people make over-sized figures.
       Scrollbars for those is therefore necessary: auto adds them as necessary..
       In the vertical direction, the line-height can combine with the font
       asender/descender height to produce scrollbars: hidden avoids that. */
    overflow: auto hidden;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: auto;
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
  &[href] {
    color: var(--pilcrow-weak);
    &:hover { text-decoration: none; }
  }
}
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
  & dt {
    width: var(--identifier-width);
    min-width: var(--identifier-width);
    clear: left;
    float: left;
    text-align: right;
    margin-right: 1ch;
  }
  & dd {
    margin: 0;
    margin-left: calc(1em + var(--identifier-width)) !important;
    min-width: 5em;
  }
  & .authors {
    & .author {
      display: inline-block;
      margin-right: 1.5em;
    }
    & .org {
      font-style: italic;
    }
  }
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;

  & nav {
    & ul {
      margin: 0 0.5em 0 0;
      padding: 0;
      list-style: none;
    }
    & li {
      line-height: 1.3em;
      margin: 2px 0;
      padding-left: 1.2em;
      text-indent: -1.2em;
    }
  }
  & a.xref {
    white-space: normal;
  }
}

.references {
  & > dt {
    text-align: right;
    font-weight: bold;
    min-width: 10ch;
    margin-right: 1.5ch;
    &:target::before {
      content: "⇒";
      margin: 0 10px 0 -25px;
    }
  }
  & > dd {
    margin-left: 12ch !important;
    overflow: visible;
    & .refInstance {
      margin-bottom: 0.8em;
    }
    & .ascii {
      margin-bottom: 0.25em;
    }
  }
}

#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  max-width: 20em;
  margin: 1em auto 1em 0;

  & .nameRole {
    font-weight: 700;
    margin-left: 0;
  }
  & .label {
    margin: 0.5em 0;
  }
  & .type {
    display: none;
  }
  & .alternative-contact {
    margin: 0.5em 0 0.25em 0;
  }
  & .non-ascii {
    margin: 0 0 0 2em;
  }
  & div.left {
    text-align: left;
  }
  & div.right {
    text-align: right;
  }
}

hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

/* Comments */
.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}

@media screen {
  #toc nav {
    font-family: var(--font-title);
    font-weight: 360;
    & > ul { margin-bottom: 2em; }
    & ul {
      margin: 0 0 0 4px;
      & :is(p, li) {
        margin: 2px 0;
      }
    }
  }
  #toc a.toplink {
    float: right;
  }
}
@media not screen {
  #toc a.toplink {
    display: none;
  }
}


/* TOC layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
    &::before { /* css hamburger */
      float: right;
      position: relative;
      width: 1em;
      height: 1px;
      left: -164px;
      margin: 8px 0 0 0;
      background: white none repeat scroll 0 0;
      box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
      content: "";
    }
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active {
    opacity: 1;
    & nav { display: block; }
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:is(:link, :focus, :hover),
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin: 2px 0.5em 0;
  }
}

/* TOC layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
  #toc a.toplink {
    margin: 8px 0.5em 0;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">TLS Encrypted Client Hello</td>
<td class="right">February 2025</td>
</tr></thead>
<tfoot><tr>
<td class="left">Rescorla, et al.</td>
<td class="center">Expires 23 August 2025</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">tls</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-tls-esni-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2025-02-19" class="published">19 February 2025</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2025-08-23">23 August 2025</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">E. Rescorla</div>
<div class="org">Independent</div>
</div>
<div class="author">
      <div class="author-name">K. Oku</div>
<div class="org">Fastly</div>
</div>
<div class="author">
      <div class="author-name">N. Sullivan</div>
<div class="org">Cryptography Consulting LLC</div>
</div>
<div class="author">
      <div class="author-name">C. A. Wood</div>
<div class="org">Cloudflare</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">TLS Encrypted Client Hello</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes a mechanism in Transport Layer Security (TLS) for
encrypting a ClientHello message under a server public key.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-discussion-venues">
<a href="#name-discussion-venues" class="section-name selfRef">Discussion Venues</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">Source for this draft and an issue tracker can be found at
  <a href="https://github.com/tlswg/draft-ietf-tls-esni">https://github.com/tlswg/draft-ietf-tls-esni</a>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 23 August 2025.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2025 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-overview" class="internal xref">Overview</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-topologies" class="internal xref">Topologies</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-encrypted-clienthello-ech" class="internal xref">Encrypted ClientHello (ECH)</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-encrypted-clienthello-confi" class="internal xref">Encrypted ClientHello Configuration</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-configuration-identifiers" class="internal xref">Configuration Identifiers</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-configuration-extensions" class="internal xref">Configuration Extensions</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-the-encrypted_client_hello-" class="internal xref">The "encrypted_client_hello" Extension</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="auto internal xref">5.1</a>.  <a href="#name-encoding-the-clienthelloinn" class="internal xref">Encoding the ClientHelloInner</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="auto internal xref">5.2</a>.  <a href="#name-authenticating-the-clienthe" class="internal xref">Authenticating the ClientHelloOuter</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-client-behavior" class="internal xref">Client Behavior</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-offering-ech" class="internal xref">Offering ECH</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.1">
                    <p id="section-toc.1-1.6.2.1.2.1.1"><a href="#section-6.1.1" class="auto internal xref">6.1.1</a>.  <a href="#name-encrypting-the-clienthello" class="internal xref">Encrypting the ClientHello</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.2">
                    <p id="section-toc.1-1.6.2.1.2.2.1"><a href="#section-6.1.2" class="auto internal xref">6.1.2</a>.  <a href="#name-grease-psk" class="internal xref">GREASE PSK</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.3">
                    <p id="section-toc.1-1.6.2.1.2.3.1"><a href="#section-6.1.3" class="auto internal xref">6.1.3</a>.  <a href="#name-recommended-padding-scheme" class="internal xref">Recommended Padding Scheme</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.4">
                    <p id="section-toc.1-1.6.2.1.2.4.1"><a href="#section-6.1.4" class="auto internal xref">6.1.4</a>.  <a href="#name-determining-ech-acceptance" class="internal xref">Determining ECH Acceptance</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.5">
                    <p id="section-toc.1-1.6.2.1.2.5.1"><a href="#section-6.1.5" class="auto internal xref">6.1.5</a>.  <a href="#name-handshaking-with-clienthell" class="internal xref">Handshaking with ClientHelloInner</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.6">
                    <p id="section-toc.1-1.6.2.1.2.6.1"><a href="#section-6.1.6" class="auto internal xref">6.1.6</a>.  <a href="#name-handshaking-with-clienthello" class="internal xref">Handshaking with ClientHelloOuter</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.7">
                    <p id="section-toc.1-1.6.2.1.2.7.1"><a href="#section-6.1.7" class="auto internal xref">6.1.7</a>.  <a href="#name-authenticating-for-the-publ" class="internal xref">Authenticating for the Public Name</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.8">
                    <p id="section-toc.1-1.6.2.1.2.8.1"><a href="#section-6.1.8" class="auto internal xref">6.1.8</a>.  <a href="#name-impact-of-retry-on-future-c" class="internal xref">Impact of Retry on Future Connections</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="auto internal xref">6.2</a>.  <a href="#name-grease-ech" class="internal xref">GREASE ECH</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-server-behavior" class="internal xref">Server Behavior</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="auto internal xref">7.1</a>.  <a href="#name-client-facing-server" class="internal xref">Client-Facing Server</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.1.2.1">
                    <p id="section-toc.1-1.7.2.1.2.1.1"><a href="#section-7.1.1" class="auto internal xref">7.1.1</a>.  <a href="#name-sending-helloretryrequest" class="internal xref">Sending HelloRetryRequest</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="auto internal xref">7.2</a>.  <a href="#name-backend-server" class="internal xref">Backend Server</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.2.2.1">
                    <p id="section-toc.1-1.7.2.2.2.1.1"><a href="#section-7.2.1" class="auto internal xref">7.2.1</a>.  <a href="#name-sending-helloretryrequest-2" class="internal xref">Sending HelloRetryRequest</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-deployment-considerations" class="internal xref">Deployment Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="auto internal xref">8.1</a>.  <a href="#name-compatibility-issues" class="internal xref">Compatibility Issues</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1.2.1">
                    <p id="section-toc.1-1.8.2.1.2.1.1"><a href="#section-8.1.1" class="auto internal xref">8.1.1</a>.  <a href="#name-misconfiguration-and-deploy" class="internal xref">Misconfiguration and Deployment Concerns</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1.2.2">
                    <p id="section-toc.1-1.8.2.1.2.2.1"><a href="#section-8.1.2" class="auto internal xref">8.1.2</a>.  <a href="#name-middleboxes" class="internal xref">Middleboxes</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="auto internal xref">8.2</a>.  <a href="#name-deployment-impact" class="internal xref">Deployment Impact</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-compliance-requirements" class="internal xref">Compliance Requirements</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="auto internal xref">10.1</a>.  <a href="#name-security-and-privacy-goals" class="internal xref">Security and Privacy Goals</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="auto internal xref">10.2</a>.  <a href="#name-unauthenticated-and-plainte" class="internal xref">Unauthenticated and Plaintext DNS</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.3">
                <p id="section-toc.1-1.10.2.3.1"><a href="#section-10.3" class="auto internal xref">10.3</a>.  <a href="#name-client-tracking" class="internal xref">Client Tracking</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.4">
                <p id="section-toc.1-1.10.2.4.1"><a href="#section-10.4" class="auto internal xref">10.4</a>.  <a href="#name-ignored-configuration-ident" class="internal xref">Ignored Configuration Identifiers and Trial Decryption</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.5">
                <p id="section-toc.1-1.10.2.5.1"><a href="#section-10.5" class="auto internal xref">10.5</a>.  <a href="#name-outer-clienthello" class="internal xref">Outer ClientHello</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.6">
                <p id="section-toc.1-1.10.2.6.1"><a href="#section-10.6" class="auto internal xref">10.6</a>.  <a href="#name-inner-clienthello" class="internal xref">Inner ClientHello</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.7">
                <p id="section-toc.1-1.10.2.7.1"><a href="#section-10.7" class="auto internal xref">10.7</a>.  <a href="#name-related-privacy-leaks" class="internal xref">Related Privacy Leaks</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.8">
                <p id="section-toc.1-1.10.2.8.1"><a href="#section-10.8" class="auto internal xref">10.8</a>.  <a href="#name-cookies" class="internal xref">Cookies</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.9">
                <p id="section-toc.1-1.10.2.9.1"><a href="#section-10.9" class="auto internal xref">10.9</a>.  <a href="#name-attacks-exploiting-acceptan" class="internal xref">Attacks Exploiting Acceptance Confirmation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10">
                <p id="section-toc.1-1.10.2.10.1"><a href="#section-10.10" class="auto internal xref">10.10</a>. <a href="#name-comparison-against-criteria" class="internal xref">Comparison Against Criteria</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10.2.1">
                    <p id="section-toc.1-1.10.2.10.2.1.1"><a href="#section-10.10.1" class="auto internal xref">10.10.1</a>.  <a href="#name-mitigate-cut-and-paste-atta" class="internal xref">Mitigate Cut-and-Paste Attacks</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10.2.2">
                    <p id="section-toc.1-1.10.2.10.2.2.1"><a href="#section-10.10.2" class="auto internal xref">10.10.2</a>.  <a href="#name-avoid-widely-shared-secrets" class="internal xref">Avoid Widely Shared Secrets</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10.2.3">
                    <p id="section-toc.1-1.10.2.10.2.3.1"><a href="#section-10.10.3" class="auto internal xref">10.10.3</a>.  <a href="#name-sni-based-denial-of-service" class="internal xref">SNI-Based Denial-of-Service Attacks</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10.2.4">
                    <p id="section-toc.1-1.10.2.10.2.4.1"><a href="#section-10.10.4" class="auto internal xref">10.10.4</a>.  <a href="#name-do-not-stick-out" class="internal xref">Do Not Stick Out</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10.2.5">
                    <p id="section-toc.1-1.10.2.10.2.5.1"><a href="#section-10.10.5" class="auto internal xref">10.10.5</a>.  <a href="#name-maintain-forward-secrecy" class="internal xref">Maintain Forward Secrecy</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10.2.6">
                    <p id="section-toc.1-1.10.2.10.2.6.1"><a href="#section-10.10.6" class="auto internal xref">10.10.6</a>.  <a href="#name-enable-multi-party-security" class="internal xref">Enable Multi-party Security Contexts</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10.2.7">
                    <p id="section-toc.1-1.10.2.10.2.7.1"><a href="#section-10.10.7" class="auto internal xref">10.10.7</a>.  <a href="#name-support-multiple-protocols" class="internal xref">Support Multiple Protocols</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.11">
                <p id="section-toc.1-1.10.2.11.1"><a href="#section-10.11" class="auto internal xref">10.11</a>. <a href="#name-padding-policy" class="internal xref">Padding Policy</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.12">
                <p id="section-toc.1-1.10.2.12.1"><a href="#section-10.12" class="auto internal xref">10.12</a>. <a href="#name-active-attack-mitigations" class="internal xref">Active Attack Mitigations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.12.2.1">
                    <p id="section-toc.1-1.10.2.12.2.1.1"><a href="#section-10.12.1" class="auto internal xref">10.12.1</a>.  <a href="#name-client-reaction-attack-miti" class="internal xref">Client Reaction Attack Mitigation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.12.2.2">
                    <p id="section-toc.1-1.10.2.12.2.2.1"><a href="#section-10.12.2" class="auto internal xref">10.12.2</a>.  <a href="#name-helloretryrequest-hijack-mi" class="internal xref">HelloRetryRequest Hijack Mitigation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.12.2.3">
                    <p id="section-toc.1-1.10.2.12.2.3.1"><a href="#section-10.12.3" class="auto internal xref">10.12.3</a>.  <a href="#name-clienthello-malleability-mi" class="internal xref">ClientHello Malleability Mitigation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.12.2.4">
                    <p id="section-toc.1-1.10.2.12.2.4.1"><a href="#section-10.12.4" class="auto internal xref">10.12.4</a>.  <a href="#name-clienthelloinner-packet-amp" class="internal xref">ClientHelloInner Packet Amplification Mitigation</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-11.1" class="auto internal xref">11.1</a>.  <a href="#name-update-of-the-tls-extension" class="internal xref">Update of the TLS ExtensionType Registry</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a href="#section-11.2" class="auto internal xref">11.2</a>.  <a href="#name-update-of-the-tls-alert-reg" class="internal xref">Update of the TLS Alert Registry</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.3">
                <p id="section-toc.1-1.11.2.3.1"><a href="#section-11.3" class="auto internal xref">11.3</a>.  <a href="#name-ech-configuration-extension" class="internal xref">ECH Configuration Extension Registry</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="auto internal xref">12</a>. <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#section-12.1" class="auto internal xref">12.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a href="#section-12.2" class="auto internal xref">12.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#appendix-A" class="auto internal xref">Appendix A</a>.  <a href="#name-echconfig-extension-guidanc" class="internal xref">ECHConfig Extension Guidance</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#appendix-B" class="auto internal xref">Appendix B</a>.  <a href="#name-linear-time-outer-extension" class="internal xref">Linear-time Outer Extension Processing</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#appendix-C" class="auto internal xref">Appendix C</a>.  <a href="#name-acknowledgements" class="internal xref">Acknowledgements</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#appendix-D" class="auto internal xref">Appendix D</a>.  <a href="#name-change-log" class="internal xref">Change Log</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.1">
                <p id="section-toc.1-1.16.2.1.1"><a href="#appendix-D.1" class="auto internal xref">D.1</a>.  <a href="#name-since-draft-ietf-tls-esni-1" class="internal xref">Since draft-ietf-tls-esni-16</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.2">
                <p id="section-toc.1-1.16.2.2.1"><a href="#appendix-D.2" class="auto internal xref">D.2</a>.  <a href="#name-since-draft-ietf-tls-esni-15" class="internal xref">Since draft-ietf-tls-esni-15</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.3">
                <p id="section-toc.1-1.16.2.3.1"><a href="#appendix-D.3" class="auto internal xref">D.3</a>.  <a href="#name-since-draft-ietf-tls-esni-14" class="internal xref">Since draft-ietf-tls-esni-14</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.4">
                <p id="section-toc.1-1.16.2.4.1"><a href="#appendix-D.4" class="auto internal xref">D.4</a>.  <a href="#name-since-draft-ietf-tls-esni-13" class="internal xref">Since draft-ietf-tls-esni-13</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.5">
                <p id="section-toc.1-1.16.2.5.1"><a href="#appendix-D.5" class="auto internal xref">D.5</a>.  <a href="#name-since-draft-ietf-tls-esni-12" class="internal xref">Since draft-ietf-tls-esni-12</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.6">
                <p id="section-toc.1-1.16.2.6.1"><a href="#appendix-D.6" class="auto internal xref">D.6</a>.  <a href="#name-since-draft-ietf-tls-esni-11" class="internal xref">Since draft-ietf-tls-esni-11</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.7">
                <p id="section-toc.1-1.16.2.7.1"><a href="#appendix-D.7" class="auto internal xref">D.7</a>.  <a href="#name-since-draft-ietf-tls-esni-10" class="internal xref">Since draft-ietf-tls-esni-10</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.8">
                <p id="section-toc.1-1.16.2.8.1"><a href="#appendix-D.8" class="auto internal xref">D.8</a>.  <a href="#name-since-draft-ietf-tls-esni-0" class="internal xref">Since draft-ietf-tls-esni-09</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#appendix-E" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="intro">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">Although TLS 1.3 <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span> encrypts most of the handshake, including the
server certificate, there are several ways in which an on-path attacker can
learn private information about the connection. The plaintext Server Name
Indication (SNI) extension in ClientHello messages, which leaks the target
domain for a given connection, is perhaps the most sensitive information
left unencrypted in TLS 1.3.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">This document specifies a new TLS extension, called Encrypted Client Hello
(ECH), that allows clients to encrypt their ClientHello to the TLS server.
This protects the SNI and other potentially sensitive fields, such as the ALPN
list <span>[<a href="#RFC7301" class="cite xref">RFC7301</a>]</span>. Co-located servers with consistent externally visible TLS
configurations and behavior, including supported versions and cipher suites and
how they respond to incoming client connections, form an anonymity set. (Note
that implementation-specific choices, such as extension ordering within TLS
messages or division of data into record-layer boundaries, can result in
different externally visible behavior, even for servers with consistent TLS
configurations.) Usage of this mechanism reveals that a client is connecting
to a particular service provider, but does not reveal which server from the
anonymity set terminates the connection. Deployment implications of this
feature are discussed in <a href="#deployment" class="auto internal xref">Section 8</a>.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">ECH is not in itself sufficient to protect the identity of the server.
The target domain may also be visible through other channels, such as
plaintext client DNS queries or visible server IP addresses. However,
DNS over HTTPS <span>[<a href="#RFC8484" class="cite xref">RFC8484</a>]</span> and DNS over TLS/DTLS <span>[<a href="#RFC7858" class="cite xref">RFC7858</a>]</span>
        <span>[<a href="#RFC8094" class="cite xref">RFC8094</a>]</span> provide mechanisms for clients to conceal
DNS lookups from network inspection, and many TLS servers host multiple domains
on the same IP address. Private origins may also be deployed behind a common
provider, such as a reverse proxy. In such environments, the SNI remains the
primary explicit signal used to determine the server's identity.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">ECH is supported in TLS 1.3 <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>, DTLS 1.3 <span>[<a href="#RFC9147" class="cite xref">RFC9147</a>]</span>, and
newer versions of the TLS and DTLS protocols.<a href="#section-1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
"SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span>
when, and only when, they appear in all capitals, as shown here. All TLS
notation comes from <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-3" class="relref">Section 3</a></span>.<a href="#section-2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="overview">
<section id="section-3">
      <h2 id="name-overview">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-overview" class="section-name selfRef">Overview</a>
      </h2>
<p id="section-3-1">This protocol is designed to operate in one of two topologies illustrated below,
which we call "Shared Mode" and "Split Mode". These modes are described in the
following section.<a href="#section-3-1" class="pilcrow">¶</a></p>
<div id="topologies">
<section id="section-3.1">
        <h3 id="name-topologies">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-topologies" class="section-name selfRef">Topologies</a>
        </h3>
<span id="name-shared-mode-topology"></span><div id="shared-mode">
<figure id="figure-1">
          <div class="alignLeft art-text artwork" id="section-3.1-1.1">
<pre>
                +---------------------+
                |                     |
                |   2001:DB8::1111    |
                |                     |
Client &lt;-----&gt;  | private.example.org |
                |                     |
                | public.example.com  |
                |                     |
                +---------------------+
                        Server
          (Client-Facing and Backend Combined)
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-shared-mode-topology" class="selfRef">Shared Mode Topology</a>
          </figcaption></figure>
</div>
<p id="section-3.1-2">In Shared Mode, the provider is the origin server for all the domains whose DNS
records point to it. In this mode, the TLS connection is terminated by the
provider.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<span id="name-split-mode-topology"></span><div id="split-mode">
<figure id="figure-2">
          <div class="alignLeft art-text artwork" id="section-3.1-3.1">
<pre>
           +--------------------+     +---------------------+
           |                    |     |                     |
           |   2001:DB8::1111   |     |   2001:DB8::EEEE    |
Client &lt;-----------------------------&gt;|                     |
           | public.example.com |     | private.example.com |
           |                    |     |                     |
           +--------------------+     +---------------------+
            Client-Facing Server            Backend Server
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-split-mode-topology" class="selfRef">Split Mode Topology</a>
          </figcaption></figure>
</div>
<p id="section-3.1-4">In Split Mode, the provider is not the origin server for private domains.
Rather, the DNS records for private domains point to the provider, and the
provider's server relays the connection back to the origin server, who
terminates the TLS connection with the client. Importantly, the service provider
does not have access to the plaintext of the connection beyond the unencrypted
portions of the handshake.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
<p id="section-3.1-5">In the remainder of this document, we will refer to the ECH-service provider as
the "client-facing server" and to the TLS terminator as the "backend server".
These are the same entity in Shared Mode, but in Split Mode, the client-facing
and backend servers are physically separated.<a href="#section-3.1-5" class="pilcrow">¶</a></p>
<p id="section-3.1-6">See <a href="#security-considerations" class="auto internal xref">Section 10</a> for more discussion about the ECH threat model
and how it relates to the client, client-facing server, and backend server.<a href="#section-3.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encrypted-clienthello-ech">
<section id="section-3.2">
        <h3 id="name-encrypted-clienthello-ech">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-encrypted-clienthello-ech" class="section-name selfRef">Encrypted ClientHello (ECH)</a>
        </h3>
<p id="section-3.2-1">A client-facing server enables ECH by publishing an ECH configuration, which
is an encryption public key and associated metadata. Domains which wish to
use ECH must publish this configuration, using the key associated
with the client-facing server. This document
defines the ECH configuration's format, but delegates DNS publication details
to <span>[<a href="#RFC9460" class="cite xref">RFC9460</a>]</span>. See
<span>[<a href="#ECH-IN-DNS" class="cite xref">ECH-IN-DNS</a>]</span> for specifics about how ECH
configurations are advertised in HTTPS records. Other delivery mechanisms are
also possible. For example, the client may have the ECH configuration
preconfigured.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">When a client wants to establish a TLS session with some backend server, it
constructs a private ClientHello, referred to as the ClientHelloInner.
The client then constructs a public ClientHello, referred to as the
ClientHelloOuter. The ClientHelloOuter contains innocuous values for
sensitive extensions and an "encrypted_client_hello" extension
(<a href="#encrypted-client-hello" class="auto internal xref">Section 5</a>), which carries the encrypted ClientHelloInner.
Finally, the client sends ClientHelloOuter to the server.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">The server takes one of the following actions:<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3.2-4">
<li id="section-3.2-4.1">
            <p id="section-3.2-4.1.1">If it does not support ECH or cannot decrypt the extension, it completes
the handshake with ClientHelloOuter. This is referred to as rejecting ECH.<a href="#section-3.2-4.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-3.2-4.2">
            <p id="section-3.2-4.2.1">If it successfully decrypts the extension, it forwards the ClientHelloInner
to the backend server, which completes the handshake. This is referred to
as accepting ECH.<a href="#section-3.2-4.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-3.2-5">Upon receiving the server's response, the client determines whether or not ECH
was accepted (<a href="#determining-ech-acceptance" class="auto internal xref">Section 6.1.4</a>) and proceeds with the handshake
accordingly. When ECH is rejected, the resulting connection is not usable by
the client for application data. Instead, ECH rejection allows the client to
retry with up-to-date configuration (<a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a>).<a href="#section-3.2-5" class="pilcrow">¶</a></p>
<p id="section-3.2-6">The primary goal of ECH is to ensure that connections to servers in the same
anonymity set are indistinguishable from one another. Moreover, it should
achieve this goal without affecting any existing security properties of TLS 1.3.
See <a href="#goals" class="auto internal xref">Section 10.1</a> for more details about the ECH security and privacy goals.<a href="#section-3.2-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="ech-configuration">
<section id="section-4">
      <h2 id="name-encrypted-clienthello-confi">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-encrypted-clienthello-confi" class="section-name selfRef">Encrypted ClientHello Configuration</a>
      </h2>
<p id="section-4-1">ECH uses HPKE for public key encryption <span>[<a href="#HPKE" class="cite xref">HPKE</a>]</span>.
The ECH configuration is defined by the following <code>ECHConfig</code> structure.<a href="#section-4-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4-2">
<pre>
    opaque HpkePublicKey&lt;1..2^16-1&gt;;
    uint16 HpkeKemId;              // Defined in RFC9180
    uint16 HpkeKdfId;              // Defined in RFC9180
    uint16 HpkeAeadId;             // Defined in RFC9180
    uint16 ECHConfigExtensionType; // Defined in Section 11.3

    struct {
        HpkeKdfId kdf_id;
        HpkeAeadId aead_id;
    } HpkeSymmetricCipherSuite;

    struct {
        uint8 config_id;
        HpkeKemId kem_id;
        HpkePublicKey public_key;
        HpkeSymmetricCipherSuite cipher_suites&lt;4..2^16-4&gt;;
    } HpkeKeyConfig;

    struct {
        ECHConfigExtensionType type;
        opaque data&lt;0..2^16-1&gt;;
    } ECHConfigExtension;

    struct {
        HpkeKeyConfig key_config;
        uint8 maximum_name_length;
        opaque public_name&lt;1..255&gt;;
        ECHConfigExtension extensions&lt;0..2^16-1&gt;;
    } ECHConfigContents;

    struct {
        uint16 version;
        uint16 length;
        select (ECHConfig.version) {
          case 0xfe0d: ECHConfigContents contents;
        }
    } ECHConfig;
</pre><a href="#section-4-2" class="pilcrow">¶</a>
</div>
<p id="section-4-3">The structure contains the following fields:<a href="#section-4-3" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-4-4">
        <dt id="section-4-4.1">version</dt>
        <dd style="margin-left: 1.5em" id="section-4-4.2">
          <p id="section-4-4.2.1">The version of ECH for which this configuration is used. The version
is the same as the code point for the
"encrypted_client_hello" extension. Clients MUST ignore any <code>ECHConfig</code>
structure with a version they do not support.<a href="#section-4-4.2.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-4-4.3">length</dt>
        <dd style="margin-left: 1.5em" id="section-4-4.4">
          <p id="section-4-4.4.1">The length, in bytes, of the next field. This length field allows
implementations to skip over the elements in such a list where they cannot
parse the specific version of ECHConfig.<a href="#section-4-4.4.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-4-4.5">contents</dt>
        <dd style="margin-left: 1.5em" id="section-4-4.6">
          <p id="section-4-4.6.1">An opaque byte string whose contents depend on the version. For this
specification, the contents are an <code>ECHConfigContents</code> structure.<a href="#section-4-4.6.1" class="pilcrow">¶</a></p>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-4-5">The <code>ECHConfigContents</code> structure contains the following fields:<a href="#section-4-5" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-4-6">
        <dt id="section-4-6.1">key_config</dt>
        <dd style="margin-left: 1.5em" id="section-4-6.2">
          <p id="section-4-6.2.1">A <code>HpkeKeyConfig</code> structure carrying the configuration information associated
with the HPKE public key. Note that this structure contains the <code>config_id</code>
field, which applies to the entire ECHConfigContents.<a href="#section-4-6.2.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-4-6.3">maximum_name_length</dt>
        <dd style="margin-left: 1.5em" id="section-4-6.4">
          <p id="section-4-6.4.1">The longest name of a backend server, if known. If not known, this value can
be set to zero. It is used to compute padding (<a href="#padding" class="auto internal xref">Section 6.1.3</a>) and does not
constrain server name lengths. Names may exceed this length if, e.g.,
the server uses wildcard names or added new names to the anonymity set.<a href="#section-4-6.4.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-4-6.5">public_name</dt>
        <dd style="margin-left: 1.5em" id="section-4-6.6">
          <p id="section-4-6.6.1">The DNS name of the client-facing server, i.e., the entity trusted
to update the ECH configuration. This is used to correct misconfigured clients,
as described in <a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a>.<a href="#section-4-6.6.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-4-6.7"></dt>
        <dd style="margin-left: 1.5em" id="section-4-6.8">
          <p id="section-4-6.8.1">See <a href="#auth-public-name" class="auto internal xref">Section 6.1.7</a> for how the client interprets and validates the
public_name.<a href="#section-4-6.8.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-4-6.9">extensions</dt>
        <dd style="margin-left: 1.5em" id="section-4-6.10">
          <p id="section-4-6.10.1">A list of ECHConfigExtension values that the client must take into
consideration when generating a ClientHello message. Each ECHConfigExtension
has a 2-octet type and opaque data value, where the data value is encoded
with a 2-octet integer representing the length of the data, in network byte
order. ECHConfigExtension values are described below (<a href="#config-extensions" class="auto internal xref">Section 4.2</a>).<a href="#section-4-6.10.1" class="pilcrow">¶</a></p>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-4-7">The <code>HpkeKeyConfig</code> structure contains the following fields:<a href="#section-4-7" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-4-8">
        <dt id="section-4-8.1">config_id</dt>
        <dd style="margin-left: 1.5em" id="section-4-8.2">
          <p id="section-4-8.2.1">A one-byte identifier for the given HPKE key configuration. This is used by
clients to indicate the key used for ClientHello encryption. <a href="#config-ids" class="auto internal xref">Section 4.1</a>
describes how client-facing servers allocate this value.<a href="#section-4-8.2.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-4-8.3">kem_id</dt>
        <dd style="margin-left: 1.5em" id="section-4-8.4">
          <p id="section-4-8.4.1">The HPKE KEM identifier corresponding to <code>public_key</code>. Clients MUST ignore any
<code>ECHConfig</code> structure with a key using a KEM they do not support.<a href="#section-4-8.4.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-4-8.5">public_key</dt>
        <dd style="margin-left: 1.5em" id="section-4-8.6">
          <p id="section-4-8.6.1">The HPKE public key used by the client to encrypt ClientHelloInner.<a href="#section-4-8.6.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-4-8.7">cipher_suites</dt>
        <dd style="margin-left: 1.5em" id="section-4-8.8">
          <p id="section-4-8.8.1">The list of HPKE KDF and AEAD identifier pairs clients can use for encrypting
ClientHelloInner. See <a href="#real-ech" class="auto internal xref">Section 6.1</a> for how clients choose from this list.<a href="#section-4-8.8.1" class="pilcrow">¶</a></p>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-4-9">The client-facing server advertises a sequence of ECH configurations to clients,
serialized as follows.<a href="#section-4-9" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4-10">
<pre>
    ECHConfig ECHConfigList&lt;4..2^16-1&gt;;
</pre><a href="#section-4-10" class="pilcrow">¶</a>
</div>
<p id="section-4-11">The <code>ECHConfigList</code> structure contains one or more <code>ECHConfig</code> structures in
decreasing order of preference. This allows a server to support multiple
versions of ECH and multiple sets of ECH parameters.<a href="#section-4-11" class="pilcrow">¶</a></p>
<div id="config-ids">
<section id="section-4.1">
        <h3 id="name-configuration-identifiers">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-configuration-identifiers" class="section-name selfRef">Configuration Identifiers</a>
        </h3>
<p id="section-4.1-1">A client-facing server has a set of known ECHConfig values, with corresponding
private keys. This set SHOULD contain the currently published values, as well as
previous values that may still be in use, since clients may cache DNS records
up to a TTL or longer.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1-2"><a href="#client-facing-server" class="auto internal xref">Section 7.1</a> describes a trial decryption process for decrypting the
ClientHello. This can impact performance when the client-facing server maintains
many known ECHConfig values. To avoid this, the client-facing server SHOULD
allocate distinct <code>config_id</code> values for each ECHConfig in its known set. The
RECOMMENDED strategy is via rejection sampling, i.e., to randomly select
<code>config_id</code> repeatedly until it does not match any known ECHConfig.<a href="#section-4.1-2" class="pilcrow">¶</a></p>
<p id="section-4.1-3">It is not necessary for <code>config_id</code> values across different client-facing
servers to be distinct. A backend server may be hosted behind two different
client-facing servers with colliding <code>config_id</code> values without any performance
impact. Values may also be reused if the previous ECHConfig is no longer in the
known set.<a href="#section-4.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="config-extensions">
<section id="section-4.2">
        <h3 id="name-configuration-extensions">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-configuration-extensions" class="section-name selfRef">Configuration Extensions</a>
        </h3>
<p id="section-4.2-1">ECH configuration extensions are used to provide room for additional
functionality as needed. See <a href="#config-extensions-guidance" class="auto internal xref">Appendix A</a> for guidance on
which types of extensions are appropriate for this structure.<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<p id="section-4.2-2">The format is as defined in <a href="#ech-configuration" class="auto internal xref">Section 4</a> and mirrors
<span><a href="https://rfc-editor.org/rfc/rfc8446#section-4.2" class="relref">Section 4.2</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>. However, ECH configuration extension types are
maintained by IANA as described in <a href="#config-extensions-iana" class="auto internal xref">Section 11.3</a>.
ECH configuration extensions follow the same interpretation rules as TLS
extensions: extensions MAY appear in any order, but there MUST NOT be more
than one extension of the same type in the extensions block. Unlike TLS
extensions, an extension can be tagged as mandatory by using an extension type
codepoint with the high order bit set to 1.<a href="#section-4.2-2" class="pilcrow">¶</a></p>
<p id="section-4.2-3">Clients MUST parse the extension list and check for unsupported mandatory
extensions. If an unsupported mandatory extension is present, clients MUST
ignore the <code>ECHConfig</code>.<a href="#section-4.2-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="encrypted-client-hello">
<section id="section-5">
      <h2 id="name-the-encrypted_client_hello-">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-the-encrypted_client_hello-" class="section-name selfRef">The "encrypted_client_hello" Extension</a>
      </h2>
<p id="section-5-1">To offer ECH, the client sends an "encrypted_client_hello" extension in the
ClientHelloOuter. When it does, it MUST also send the extension in
ClientHelloInner.<a href="#section-5-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5-2">
<pre>
    enum {
       encrypted_client_hello(0xfe0d), (65535)
    } ExtensionType;
</pre><a href="#section-5-2" class="pilcrow">¶</a>
</div>
<p id="section-5-3">The payload of the extension has the following structure:<a href="#section-5-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5-4">
<pre>
    enum { outer(0), inner(1) } ECHClientHelloType;

    struct {
       ECHClientHelloType type;
       select (ECHClientHello.type) {
           case outer:
               HpkeSymmetricCipherSuite cipher_suite;
               uint8 config_id;
               opaque enc&lt;0..2^16-1&gt;;
               opaque payload&lt;1..2^16-1&gt;;
           case inner:
               Empty;
       };
    } ECHClientHello;
</pre><a href="#section-5-4" class="pilcrow">¶</a>
</div>
<p id="section-5-5">The outer extension uses the <code>outer</code> variant and the inner extension uses the
<code>inner</code> variant. The inner extension has an empty payload, which is included
because TLS servers are not allowed to provide extensions in ServerHello
which were not included in ClientHello. The outer extension has the following
fields:<a href="#section-5-5" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-5-6">
        <dt id="section-5-6.1">config_id</dt>
        <dd style="margin-left: 1.5em" id="section-5-6.2">
          <p id="section-5-6.2.1">The ECHConfigContents.key_config.config_id for the chosen ECHConfig.<a href="#section-5-6.2.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-5-6.3">cipher_suite</dt>
        <dd style="margin-left: 1.5em" id="section-5-6.4">
          <p id="section-5-6.4.1">The cipher suite used to encrypt ClientHelloInner. This MUST match a value
provided in the corresponding <code>ECHConfigContents.cipher_suites</code> list.<a href="#section-5-6.4.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-5-6.5">enc</dt>
        <dd style="margin-left: 1.5em" id="section-5-6.6">
          <p id="section-5-6.6.1">The HPKE encapsulated key, used by servers to decrypt the corresponding
<code>payload</code> field. This field is empty in a ClientHelloOuter sent in response to
HelloRetryRequest.<a href="#section-5-6.6.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-5-6.7">payload</dt>
        <dd style="margin-left: 1.5em" id="section-5-6.8">
          <p id="section-5-6.8.1">The serialized and encrypted EncodedClientHelloInner structure, encrypted
using HPKE as described in <a href="#real-ech" class="auto internal xref">Section 6.1</a>.<a href="#section-5-6.8.1" class="pilcrow">¶</a></p>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-5-7">When a client offers the <code>outer</code> version of an "encrypted_client_hello"
extension, the server MAY include an "encrypted_client_hello" extension in its
EncryptedExtensions message, as described in <a href="#client-facing-server" class="auto internal xref">Section 7.1</a>, with the
following payload:<a href="#section-5-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5-8">
<pre>
    struct {
       ECHConfigList retry_configs;
    } ECHEncryptedExtensions;
</pre><a href="#section-5-8" class="pilcrow">¶</a>
</div>
<p id="section-5-9">The response is valid only when the server used the ClientHelloOuter. If the
server sent this extension in response to the <code>inner</code> variant, then the client
MUST abort with an "unsupported_extension" alert.<a href="#section-5-9" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-5-10">
        <dt id="section-5-10.1">retry_configs</dt>
        <dd style="margin-left: 1.5em" id="section-5-10.2">
          <p id="section-5-10.2.1">An ECHConfigList structure containing one or more ECHConfig structures, in
decreasing order of preference, to be used by the client as described in
<a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a>. These are known as the server's "retry configurations".<a href="#section-5-10.2.1" class="pilcrow">¶</a></p>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-5-11">Finally, when the client offers the "encrypted_client_hello", if the payload is
the <code>inner</code> variant and the server responds with HelloRetryRequest, it MUST
include an "encrypted_client_hello" extension with the following payload:<a href="#section-5-11" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5-12">
<pre>
    struct {
       opaque confirmation[8];
    } ECHHelloRetryRequest;
</pre><a href="#section-5-12" class="pilcrow">¶</a>
</div>
<p id="section-5-13">The value of ECHHelloRetryRequest.confirmation is set to
<code>hrr_accept_confirmation</code> as described in <a href="#backend-server-hrr" class="auto internal xref">Section 7.2.1</a>.<a href="#section-5-13" class="pilcrow">¶</a></p>
<p id="section-5-14">This document also defines the "ech_required" alert, which the client MUST send
when it offered an "encrypted_client_hello" extension that was not accepted by
the server. (See <a href="#alerts" class="auto internal xref">Section 11.2</a>.)<a href="#section-5-14" class="pilcrow">¶</a></p>
<div id="encoding-inner">
<section id="section-5.1">
        <h3 id="name-encoding-the-clienthelloinn">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-encoding-the-clienthelloinn" class="section-name selfRef">Encoding the ClientHelloInner</a>
        </h3>
<p id="section-5.1-1">Before encrypting, the client pads and optionally compresses ClientHelloInner
into a EncodedClientHelloInner structure, defined below:<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-2">
<pre>
    struct {
        ClientHello client_hello;
        uint8 zeros[length_of_padding];
    } EncodedClientHelloInner;
</pre><a href="#section-5.1-2" class="pilcrow">¶</a>
</div>
<p id="section-5.1-3">The <code>client_hello</code> field is computed by first making a copy of ClientHelloInner
and setting the <code>legacy_session_id</code> field to the empty string. In TLS, this
field uses the ClientHello structure defined in <span><a href="https://rfc-editor.org/rfc/rfc8446#section-4.1.2" class="relref">Section 4.1.2</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>.
In DTLS, it uses the ClientHello structured defined in
<span><a href="https://rfc-editor.org/rfc/rfc9147#section-5.3" class="relref">Section 5.3</a> of [<a href="#RFC9147" class="cite xref">RFC9147</a>]</span>. This does not include Handshake structure's
four-byte header in TLS, nor twelve-byte header in DTLS. The <code>zeros</code> field MUST
be all zeroes.<a href="#section-5.1-3" class="pilcrow">¶</a></p>
<p id="section-5.1-4">Repeating large extensions, such as "key_share" with post-quantum algorithms,
between ClientHelloInner and ClientHelloOuter can lead to excessive size. To
reduce the size impact, the client MAY substitute extensions which it knows
will be duplicated in ClientHelloOuter. It does so by removing and replacing
extensions from EncodedClientHelloInner with a single "ech_outer_extensions"
extension, defined as follows:<a href="#section-5.1-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-5">
<pre>
    enum {
       ech_outer_extensions(0xfd00), (65535)
    } ExtensionType;

    ExtensionType OuterExtensions&lt;2..254&gt;;
</pre><a href="#section-5.1-5" class="pilcrow">¶</a>
</div>
<p id="section-5.1-6">OuterExtensions contains the removed ExtensionType values. Each value references
the matching extension in ClientHelloOuter. The values MUST be ordered
contiguously in ClientHelloInner, and the "ech_outer_extensions" extension MUST
be inserted in the corresponding position in EncodedClientHelloInner.
Additionally, the extensions MUST appear in ClientHelloOuter in the same
relative order. However, there is no requirement that they be contiguous. For
example, OuterExtensions may contain extensions A, B, C, while ClientHelloOuter
contains extensions A, D, B, C, E, F.<a href="#section-5.1-6" class="pilcrow">¶</a></p>
<p id="section-5.1-7">The "ech_outer_extensions" extension can only be included in
EncodedClientHelloInner, and MUST NOT appear in either ClientHelloOuter or
ClientHelloInner.<a href="#section-5.1-7" class="pilcrow">¶</a></p>
<p id="section-5.1-8">Finally, the client pads the message by setting the <code>zeros</code> field to a byte
string whose contents are all zeros and whose length is the amount of padding
to add. <a href="#padding" class="auto internal xref">Section 6.1.3</a> describes a recommended padding scheme.<a href="#section-5.1-8" class="pilcrow">¶</a></p>
<p id="section-5.1-9">The client-facing server computes ClientHelloInner by reversing this process.
First it parses EncodedClientHelloInner, interpreting all bytes after
<code>client_hello</code> as padding. If any padding byte is non-zero, the server MUST
abort the connection with an "illegal_parameter" alert.<a href="#section-5.1-9" class="pilcrow">¶</a></p>
<p id="section-5.1-10">Next it makes a copy of the <code>client_hello</code> field and copies the
<code>legacy_session_id</code> field from ClientHelloOuter. It then looks for an
"ech_outer_extensions" extension. If found, it replaces the extension with the
corresponding sequence of extensions in the ClientHelloOuter. The server MUST
abort the connection with an "illegal_parameter" alert if any of the following
are true:<a href="#section-5.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.1-11.1">
            <p id="section-5.1-11.1.1">Any referenced extension is missing in ClientHelloOuter.<a href="#section-5.1-11.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.1-11.2">
            <p id="section-5.1-11.2.1">Any extension is referenced in OuterExtensions more than once.<a href="#section-5.1-11.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.1-11.3">
            <p id="section-5.1-11.3.1">"encrypted_client_hello" is referenced in OuterExtensions.<a href="#section-5.1-11.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.1-11.4">
            <p id="section-5.1-11.4.1">The extensions in ClientHelloOuter corresponding to those in OuterExtensions
do not occur in the same order.<a href="#section-5.1-11.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.1-12">These requirements prevent an attacker from performing a packet amplification
attack, by crafting a ClientHelloOuter which decompresses to a much larger
ClientHelloInner. This is discussed further in <a href="#decompression-amp" class="auto internal xref">Section 10.12.4</a>.<a href="#section-5.1-12" class="pilcrow">¶</a></p>
<p id="section-5.1-13">Implementations SHOULD construct the ClientHelloInner in linear
time. Quadratic time implementations (such as may happen via naive
copying) create a denial of service risk.
<a href="#linear-outer-extensions" class="auto internal xref">Appendix B</a> describes a linear-time procedure that may be used
for this purpose.<a href="#section-5.1-13" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authenticating-outer">
<section id="section-5.2">
        <h3 id="name-authenticating-the-clienthe">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-authenticating-the-clienthe" class="section-name selfRef">Authenticating the ClientHelloOuter</a>
        </h3>
<p id="section-5.2-1">To prevent a network attacker from modifying the <code>ClientHelloOuter</code>
while keeping the same encrypted <code>ClientHelloInner</code>
(see <a href="#flow-clienthello-malleability" class="auto internal xref">Section 10.12.3</a>), ECH authenticates ClientHelloOuter
by passing ClientHelloOuterAAD as the associated data for HPKE sealing
and opening operations. The ClientHelloOuterAAD is a serialized
ClientHello structure, defined in <span><a href="https://rfc-editor.org/rfc/rfc8446#section-4.1.2" class="relref">Section 4.1.2</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span> for TLS and
<span><a href="https://rfc-editor.org/rfc/rfc9147#section-5.3" class="relref">Section 5.3</a> of [<a href="#RFC9147" class="cite xref">RFC9147</a>]</span> for DTLS, which matches the ClientHelloOuter except
that the <code>payload</code> field of the "encrypted_client_hello" is replaced with a byte
string of the same length but whose contents are zeros. This value does not
include Handshake structure's four-byte header in TLS, nor twelve-byte header in
DTLS.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="client-behavior">
<section id="section-6">
      <h2 id="name-client-behavior">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-client-behavior" class="section-name selfRef">Client Behavior</a>
      </h2>
<p id="section-6-1">Clients that implement the ECH extension behave in one of two ways: either they
offer a real ECH extension, as described in <a href="#real-ech" class="auto internal xref">Section 6.1</a>; or they send a GREASE
ECH extension, as described in <a href="#grease-ech" class="auto internal xref">Section 6.2</a>. Clients of the latter type do not
negotiate ECH. Instead, they generate a dummy ECH extension that is ignored by
the server. (See <a href="#dont-stick-out" class="auto internal xref">Section 10.10.4</a> for an explanation.) The client offers ECH
if it is in possession of a compatible ECH configuration and sends GREASE ECH
otherwise.<a href="#section-6-1" class="pilcrow">¶</a></p>
<div id="real-ech">
<section id="section-6.1">
        <h3 id="name-offering-ech">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-offering-ech" class="section-name selfRef">Offering ECH</a>
        </h3>
<p id="section-6.1-1">To offer ECH, the client first chooses a suitable ECHConfig from the server's
ECHConfigList. To determine if a given <code>ECHConfig</code> is suitable, it checks that
it supports the KEM algorithm identified by <code>ECHConfig.contents.kem_id</code>, at
least one KDF/AEAD algorithm identified by <code>ECHConfig.contents.cipher_suites</code>,
and the version of ECH indicated by <code>ECHConfig.contents.version</code>. Once a
suitable configuration is found, the client selects the cipher suite it will
use for encryption. It MUST NOT choose a cipher suite or version not advertised
by the configuration. If no compatible configuration is found, then the client
SHOULD proceed as described in <a href="#grease-ech" class="auto internal xref">Section 6.2</a>.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<p id="section-6.1-2">Next, the client constructs the ClientHelloInner message just as it does a
standard ClientHello, with the exception of the following rules:<a href="#section-6.1-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1-3">
<li id="section-6.1-3.1">
            <p id="section-6.1-3.1.1">It MUST NOT offer to negotiate TLS 1.2 or below. This is necessary to ensure
the backend server does not negotiate a TLS version that is incompatible with
ECH.<a href="#section-6.1-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-3.2">
            <p id="section-6.1-3.2.1">It MUST NOT offer to resume any session for TLS 1.2 and below.<a href="#section-6.1-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-3.3">
            <p id="section-6.1-3.3.1">If it intends to compress any extensions (see <a href="#encoding-inner" class="auto internal xref">Section 5.1</a>), it MUST
order those extensions consecutively.<a href="#section-6.1-3.3.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-3.4">
            <p id="section-6.1-3.4.1">It MUST include the "encrypted_client_hello" extension of type <code>inner</code> as
described in <a href="#encrypted-client-hello" class="auto internal xref">Section 5</a>. (This requirement is not applicable
when the "encrypted_client_hello" extension is generated as described in
<a href="#grease-ech" class="auto internal xref">Section 6.2</a>.)<a href="#section-6.1-3.4.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-6.1-4">The client then constructs EncodedClientHelloInner as described in
<a href="#encoding-inner" class="auto internal xref">Section 5.1</a>. It also computes an HPKE encryption context and <code>enc</code> value
as:<a href="#section-6.1-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.1-5">
<pre>
    pkR = DeserializePublicKey(ECHConfig.contents.public_key)
    enc, context = SetupBaseS(pkR,
                              "tls ech" || 0x00 || ECHConfig)
</pre><a href="#section-6.1-5" class="pilcrow">¶</a>
</div>
<p id="section-6.1-6">Next, it constructs a partial ClientHelloOuterAAD as it does a standard
ClientHello, with the exception of the following rules:<a href="#section-6.1-6" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1-7">
<li id="section-6.1-7.1">
            <p id="section-6.1-7.1.1">It MUST offer to negotiate TLS 1.3 or above.<a href="#section-6.1-7.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-7.2">
            <p id="section-6.1-7.2.1">If it compressed any extensions in EncodedClientHelloInner, it MUST copy the
corresponding extensions from ClientHelloInner. The copied extensions
additionally MUST be in the same relative order as in ClientHelloInner.<a href="#section-6.1-7.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-7.3">
            <p id="section-6.1-7.3.1">It MUST copy the legacy_session_id field from ClientHelloInner. This
allows the server to echo the correct session ID for TLS 1.3's compatibility
mode (see Appendix D.4 of <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>) when ECH is negotiated.<a href="#section-6.1-7.3.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-7.4">
            <p id="section-6.1-7.4.1">It MAY copy any other field from the ClientHelloInner except
ClientHelloInner.random. Instead, It MUST generate a fresh
ClientHelloOuter.random using a secure random number generator. (See
<a href="#flow-client-reaction" class="auto internal xref">Section 10.12.1</a>.)<a href="#section-6.1-7.4.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-7.5">
            <p id="section-6.1-7.5.1">It SHOULD place the value of <code>ECHConfig.contents.public_name</code> in the
"server_name" extension. Clients that do not follow this step, or place a
different value in the "server_name" extension, risk breaking the retry
mechanism described in <a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a> or failing to interoperate with
servers that require this step to be done; see <a href="#client-facing-server" class="auto internal xref">Section 7.1</a>.<a href="#section-6.1-7.5.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-7.6">
            <p id="section-6.1-7.6.1">When the client offers the "pre_shared_key" extension in ClientHelloInner, it
SHOULD also include a GREASE "pre_shared_key" extension in ClientHelloOuter,
generated in the manner described in <a href="#grease-psk" class="auto internal xref">Section 6.1.2</a>. The client MUST NOT use
this extension to advertise a PSK to the client-facing server. (See
<a href="#flow-clienthello-malleability" class="auto internal xref">Section 10.12.3</a>.) When the client includes a GREASE
"pre_shared_key" extension, it MUST also copy the "psk_key_exchange_modes"
from the ClientHelloInner into the ClientHelloOuter.<a href="#section-6.1-7.6.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-6.1-7.7">
            <p id="section-6.1-7.7.1">When the client offers the "early_data" extension in ClientHelloInner, it
MUST also include the "early_data" extension in ClientHelloOuter. This
allows servers that reject ECH and use ClientHelloOuter to safely ignore any
early data sent by the client per <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-4.2.10" class="relref">Section 4.2.10</a></span>.<a href="#section-6.1-7.7.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-6.1-8">Note that these rules may change in the presence of an application profile
specifying otherwise.<a href="#section-6.1-8" class="pilcrow">¶</a></p>
<p id="section-6.1-9">The client might duplicate non-sensitive extensions in both messages. However,
implementations need to take care to ensure that sensitive extensions are not
offered in the ClientHelloOuter. See <a href="#outer-clienthello" class="auto internal xref">Section 10.5</a> for additional
guidance.<a href="#section-6.1-9" class="pilcrow">¶</a></p>
<p id="section-6.1-10">Finally, the client encrypts the EncodedClientHelloInner with the above values,
as described in <a href="#encrypting-clienthello" class="auto internal xref">Section 6.1.1</a>, to construct a ClientHelloOuter. It
sends this to the server, and processes the response as described in
<a href="#determining-ech-acceptance" class="auto internal xref">Section 6.1.4</a>.<a href="#section-6.1-10" class="pilcrow">¶</a></p>
<div id="encrypting-clienthello">
<section id="section-6.1.1">
          <h4 id="name-encrypting-the-clienthello">
<a href="#section-6.1.1" class="section-number selfRef">6.1.1. </a><a href="#name-encrypting-the-clienthello" class="section-name selfRef">Encrypting the ClientHello</a>
          </h4>
<p id="section-6.1.1-1">Given an EncodedClientHelloInner, an HPKE encryption context and <code>enc</code> value,
and a partial ClientHelloOuterAAD, the client constructs a ClientHelloOuter as
follows.<a href="#section-6.1.1-1" class="pilcrow">¶</a></p>
<p id="section-6.1.1-2">First, the client determines the length L of encrypting EncodedClientHelloInner
with the selected HPKE AEAD. This is typically the sum of the plaintext length
and the AEAD tag length. The client then completes the ClientHelloOuterAAD with
an "encrypted_client_hello" extension. This extension value contains the outer
variant of ECHClientHello with the following fields:<a href="#section-6.1.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1.1-3.1">
              <p id="section-6.1.1-3.1.1"><code>config_id</code>, the identifier corresponding to the chosen ECHConfig structure;<a href="#section-6.1.1-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.1.1-3.2">
              <p id="section-6.1.1-3.2.1"><code>cipher_suite</code>, the client's chosen cipher suite;<a href="#section-6.1.1-3.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.1.1-3.3">
              <p id="section-6.1.1-3.3.1"><code>enc</code>, as given above; and<a href="#section-6.1.1-3.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.1.1-3.4">
              <p id="section-6.1.1-3.4.1"><code>payload</code>, a placeholder byte string containing L zeros.<a href="#section-6.1.1-3.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-6.1.1-4">If configuration identifiers (see <a href="#ignored-configs" class="auto internal xref">Section 10.4</a>) are to be ignored,
<code>config_id</code> SHOULD be set to a randomly generated byte in the first
ClientHelloOuter and, in the event of HRR, MUST be left unchanged for
the second ClientHelloOuter.<a href="#section-6.1.1-4" class="pilcrow">¶</a></p>
<p id="section-6.1.1-5">The client serializes this structure to construct the ClientHelloOuterAAD.
It then computes the final payload as:<a href="#section-6.1.1-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.1.1-6">
<pre>
    final_payload = context.Seal(ClientHelloOuterAAD,
                                 EncodedClientHelloInner)
</pre><a href="#section-6.1.1-6" class="pilcrow">¶</a>
</div>
<p id="section-6.1.1-7">Including <code>ClientHelloOuterAAD</code> as the HPKE AAD binds the <code>ClientHelloOuter</code>
to the <code>ClientHelloInner</code>, this preventing attackers from modifying
<code>ClientHelloOuter</code> while keeping the same <code>ClientHelloInner</code>, as described in
<a href="#flow-clienthello-malleability" class="auto internal xref">Section 10.12.3</a>.<a href="#section-6.1.1-7" class="pilcrow">¶</a></p>
<p id="section-6.1.1-8">Finally, the client replaces <code>payload</code> with <code>final_payload</code> to obtain
ClientHelloOuter. The two values have the same length, so it is not necessary
to recompute length prefixes in the serialized structure.<a href="#section-6.1.1-8" class="pilcrow">¶</a></p>
<p id="section-6.1.1-9">Note this construction requires the "encrypted_client_hello" be computed after
all other extensions. This is possible because the ClientHelloOuter's
"pre_shared_key" extension is either omitted, or uses a random binder
(<a href="#grease-psk" class="auto internal xref">Section 6.1.2</a>).<a href="#section-6.1.1-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="grease-psk">
<section id="section-6.1.2">
          <h4 id="name-grease-psk">
<a href="#section-6.1.2" class="section-number selfRef">6.1.2. </a><a href="#name-grease-psk" class="section-name selfRef">GREASE PSK</a>
          </h4>
<p id="section-6.1.2-1">When offering ECH, the client is not permitted to advertise PSK identities in
the ClientHelloOuter. However, the client can send a "pre_shared_key" extension
in the ClientHelloInner. In this case, when resuming a session with the client,
the backend server sends a "pre_shared_key" extension in its ServerHello. This
would appear to a network observer as if the server were sending this
extension without solicitation, which would violate the extension rules
described in <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>. When offering a PSK in ClientHelloInner,
clients SHOULD send a GREASE "pre_shared_key" extension in the
ClientHelloOuter to make it appear to the network as if the extension were
negotiated properly.<a href="#section-6.1.2-1" class="pilcrow">¶</a></p>
<p id="section-6.1.2-2">The client generates the extension payload by constructing an <code>OfferedPsks</code>
structure (see <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-4.2.11" class="relref">Section 4.2.11</a></span>) as follows. For each PSK identity
advertised in the ClientHelloInner, the client generates a random PSK identity
with the same length. It also generates a random, 32-bit, unsigned integer to
use as the <code>obfuscated_ticket_age</code>. Likewise, for each inner PSK binder, the
client generates a random string of the same length.<a href="#section-6.1.2-2" class="pilcrow">¶</a></p>
<p id="section-6.1.2-3">Per the rules of <a href="#real-ech" class="auto internal xref">Section 6.1</a>, the server is not permitted to resume a
connection in the outer handshake. If ECH is rejected and the client-facing
server replies with a "pre_shared_key" extension in its ServerHello, then the
client MUST abort the handshake with an "illegal_parameter" alert.<a href="#section-6.1.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="padding">
<section id="section-6.1.3">
          <h4 id="name-recommended-padding-scheme">
<a href="#section-6.1.3" class="section-number selfRef">6.1.3. </a><a href="#name-recommended-padding-scheme" class="section-name selfRef">Recommended Padding Scheme</a>
          </h4>
<p id="section-6.1.3-1">If the ClientHelloInner is encrypted without padding, then the length of
the <code>ClientHelloOuter.payload</code> can leak information about <code>ClientHelloInner</code>.
In order to prevent this the <code>EncodedClientHelloInner</code> structure
has a padding field. This section describes a deterministic mechanism for
computing the required amount of padding based on the following
observation: individual extensions can reveal sensitive information through
-their length. Thus, each extension in the inner ClientHello may require
different amounts of padding. This padding may be fully determined by the
client's configuration or may require server input.<a href="#section-6.1.3-1" class="pilcrow">¶</a></p>
<p id="section-6.1.3-2">By way of example, clients typically support a small number of application
profiles. For instance, a browser might support HTTP with ALPN values
["http/1.1", "h2"] and WebRTC media with ALPNs ["webrtc", "c-webrtc"]. Clients
SHOULD pad this extension by rounding up to the total size of the longest ALPN
extension across all application profiles. The target padding length of most
ClientHello extensions can be computed in this way.<a href="#section-6.1.3-2" class="pilcrow">¶</a></p>
<p id="section-6.1.3-3">In contrast, clients do not know the longest SNI value in the client-facing
server's anonymity set without server input. Clients SHOULD use the ECHConfig's
<code>maximum_name_length</code> field as follows, where L is the <code>maximum_name_length</code>
value.<a href="#section-6.1.3-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1.3-4">
<li id="section-6.1.3-4.1">
              <p id="section-6.1.3-4.1.1">If the ClientHelloInner contained a "server_name" extension with a name of
length D, add max(0, L - D) bytes of padding.<a href="#section-6.1.3-4.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-6.1.3-4.2">
              <p id="section-6.1.3-4.2.1">If the ClientHelloInner did not contain a "server_name" extension (e.g., if
the client is connecting to an IP address), add L + 9 bytes of padding. This
is the length of a "server_name" extension with an L-byte name.<a href="#section-6.1.3-4.2.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-6.1.3-5">Finally, the client SHOULD pad the entire message as follows:<a href="#section-6.1.3-5" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1.3-6">
<li id="section-6.1.3-6.1">
              <p id="section-6.1.3-6.1.1">Let L be the length of the EncodedClientHelloInner with all the padding
computed so far.<a href="#section-6.1.3-6.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-6.1.3-6.2">
              <p id="section-6.1.3-6.2.1">Let N = 31 - ((L - 1) % 32) and add N bytes of padding.<a href="#section-6.1.3-6.2.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-6.1.3-7">This rounds the length of EncodedClientHelloInner up to a multiple of 32 bytes,
reducing the set of possible lengths across all clients.<a href="#section-6.1.3-7" class="pilcrow">¶</a></p>
<p id="section-6.1.3-8">In addition to padding ClientHelloInner, clients and servers will also need to
pad all other handshake messages that have sensitive-length fields. For example,
if a client proposes ALPN values in ClientHelloInner, the server-selected value
will be returned in an EncryptedExtension, so that handshake message also needs
to be padded using TLS record layer padding.<a href="#section-6.1.3-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="determining-ech-acceptance">
<section id="section-6.1.4">
          <h4 id="name-determining-ech-acceptance">
<a href="#section-6.1.4" class="section-number selfRef">6.1.4. </a><a href="#name-determining-ech-acceptance" class="section-name selfRef">Determining ECH Acceptance</a>
          </h4>
<p id="section-6.1.4-1">As described in <a href="#server-behavior" class="auto internal xref">Section 7</a>, the server may either accept ECH and use
ClientHelloInner or reject it and use ClientHelloOuter. This is determined by
the server's initial message.<a href="#section-6.1.4-1" class="pilcrow">¶</a></p>
<p id="section-6.1.4-2">If the message does not negotiate TLS 1.3 or higher, the server has rejected
ECH. Otherwise, it is either a ServerHello or HelloRetryRequest.<a href="#section-6.1.4-2" class="pilcrow">¶</a></p>
<p id="section-6.1.4-3">If the message is a ServerHello, the client computes <code>accept_confirmation</code> as
described in <a href="#backend-server" class="auto internal xref">Section 7.2</a>. If this value matches the last 8 bytes of
<code>ServerHello.random</code>, the server has accepted ECH. Otherwise, it has rejected
ECH.<a href="#section-6.1.4-3" class="pilcrow">¶</a></p>
<p id="section-6.1.4-4">If the message is a HelloRetryRequest, the client checks for the
"encrypted_client_hello" extension. If none is found, the server has rejected
ECH. Otherwise, if it has a length other than 8, the client aborts the handshake
with a "decode_error" alert. Otherwise, the client computes
<code>hrr_accept_confirmation</code> as described in <a href="#backend-server-hrr" class="auto internal xref">Section 7.2.1</a>. If this value
matches the extension payload, the server has accepted ECH. Otherwise, it has
rejected ECH.<a href="#section-6.1.4-4" class="pilcrow">¶</a></p>
<p id="section-6.1.4-5">If the server accepts ECH, the client handshakes with ClientHelloInner as
described in <a href="#accepted-ech" class="auto internal xref">Section 6.1.5</a>. Otherwise, the client handshakes with
ClientHelloOuter as described in <a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a>.<a href="#section-6.1.4-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="accepted-ech">
<section id="section-6.1.5">
          <h4 id="name-handshaking-with-clienthell">
<a href="#section-6.1.5" class="section-number selfRef">6.1.5. </a><a href="#name-handshaking-with-clienthell" class="section-name selfRef">Handshaking with ClientHelloInner</a>
          </h4>
<p id="section-6.1.5-1">If the server accepts ECH, the client proceeds with the connection as in
<span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>, with the following modifications:<a href="#section-6.1.5-1" class="pilcrow">¶</a></p>
<p id="section-6.1.5-2">The client behaves as if it had sent ClientHelloInner as the ClientHello. That
is, it evaluates the handshake using the ClientHelloInner's preferences, and,
when computing the transcript hash (<span><a href="https://rfc-editor.org/rfc/rfc8446#section-4.4.1" class="relref">Section 4.4.1</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>), it uses
ClientHelloInner as the first ClientHello.<a href="#section-6.1.5-2" class="pilcrow">¶</a></p>
<p id="section-6.1.5-3">If the server responds with a HelloRetryRequest, the client computes the updated
ClientHello message as follows:<a href="#section-6.1.5-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-6.1.5-4">
<li id="section-6.1.5-4.1">
              <p id="section-6.1.5-4.1.1">It computes a second ClientHelloInner based on the first ClientHelloInner, as
in <span><a href="https://rfc-editor.org/rfc/rfc8446#section-4.1.4" class="relref">Section 4.1.4</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>. The ClientHelloInner's
"encrypted_client_hello" extension is left unmodified.<a href="#section-6.1.5-4.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-6.1.5-4.2">
              <p id="section-6.1.5-4.2.1">It constructs EncodedClientHelloInner as described in <a href="#encoding-inner" class="auto internal xref">Section 5.1</a>.<a href="#section-6.1.5-4.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-6.1.5-4.3">
              <p id="section-6.1.5-4.3.1">It constructs a second partial ClientHelloOuterAAD message. This message MUST
be syntactically valid. The extensions MAY be copied from the original
ClientHelloOuter unmodified, or omitted. If not sensitive, the client MAY
copy updated extensions from the second ClientHelloInner for compression.<a href="#section-6.1.5-4.3.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-6.1.5-4.4">
              <p id="section-6.1.5-4.4.1">It encrypts EncodedClientHelloInner as described in
<a href="#encrypting-clienthello" class="auto internal xref">Section 6.1.1</a>, using the second partial ClientHelloOuterAAD, to
obtain a second ClientHelloOuter. It reuses the original HPKE encryption
context computed in <a href="#real-ech" class="auto internal xref">Section 6.1</a> and uses the empty string for <code>enc</code>.<a href="#section-6.1.5-4.4.1" class="pilcrow">¶</a></p>
<p id="section-6.1.5-4.4.2">
The HPKE context maintains a sequence number, so this operation internally
uses a fresh nonce for each AEAD operation. Reusing the HPKE context avoids
an attack described in <a href="#flow-hrr-hijack" class="auto internal xref">Section 10.12.2</a>.<a href="#section-6.1.5-4.4.2" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-6.1.5-5">The client then sends the second ClientHelloOuter to the server. However, as
above, it uses the second ClientHelloInner for preferences, and both the
ClientHelloInner messages for the transcript hash. Additionally, it checks the
resulting ServerHello for ECH acceptance as in <a href="#determining-ech-acceptance" class="auto internal xref">Section 6.1.4</a>.
If the ServerHello does not also indicate ECH acceptance, the client MUST
terminate the connection with an "illegal_parameter" alert.<a href="#section-6.1.5-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="rejected-ech">
<section id="section-6.1.6">
          <h4 id="name-handshaking-with-clienthello">
<a href="#section-6.1.6" class="section-number selfRef">6.1.6. </a><a href="#name-handshaking-with-clienthello" class="section-name selfRef">Handshaking with ClientHelloOuter</a>
          </h4>
<p id="section-6.1.6-1">If the server rejects ECH, the client proceeds with the handshake,
authenticating for ECHConfig.contents.public_name as described in
<a href="#auth-public-name" class="auto internal xref">Section 6.1.7</a>. If authentication or the handshake fails, the client MUST
return a failure to the calling application. It MUST NOT use the retry
configurations. It MUST NOT treat this as a secure signal to
disable ECH.<a href="#section-6.1.6-1" class="pilcrow">¶</a></p>
<p id="section-6.1.6-2">If the server supplied an "encrypted_client_hello" extension in its
EncryptedExtensions message, the client MUST check that it is syntactically
valid and the client MUST abort the connection with a "decode_error" alert
otherwise. If an earlier TLS version was negotiated, the client MUST NOT enable
the False Start optimization <span>[<a href="#RFC7918" class="cite xref">RFC7918</a>]</span> for this handshake. If both
authentication and the handshake complete successfully, the client MUST perform
the processing described below then abort the connection with an "ech_required"
alert before sending any application data to the server.<a href="#section-6.1.6-2" class="pilcrow">¶</a></p>
<p id="section-6.1.6-3">If the server provided "retry_configs" and if at least one of the values
contains a version supported by the client, the client can regard the ECH keys
as securely replaced by the server. It SHOULD retry the handshake with a new
transport connection, using the retry configurations supplied by the
server.<a href="#section-6.1.6-3" class="pilcrow">¶</a></p>
<p id="section-6.1.6-4">Clients can implement a new transport connection in a way that best
suits their deployment. For example, clients can reuse the same IP address
when establishing the new transport connection or they can choose to use a
different IP address if provided with options from DNS. ECH does not mandate
any specific implementation choices when establishing this new connection.<a href="#section-6.1.6-4" class="pilcrow">¶</a></p>
<p id="section-6.1.6-5">The retry configurations are meant to be used for retried connections. Further
use of retry configurations could yield a tracking vector. In settings where
the client will otherwise already let the server track the client, e.g.,
because the client will send cookies to the server in parallel connections,
using the retry configurations for these parallel connections does not
introduce a new tracking vector.<a href="#section-6.1.6-5" class="pilcrow">¶</a></p>
<p id="section-6.1.6-6">If none of the values provided in "retry_configs" contains a supported
version, the server did not supply an "encrypted_client_hello"
extension in its EncryptedExtensions message, or an earlier TLS
version was negotiated, the client can regard ECH as securely disabled
by the server, and it SHOULD retry the handshake with a new transport
connection and ECH disabled.<a href="#section-6.1.6-6" class="pilcrow">¶</a></p>
<p id="section-6.1.6-7">Clients SHOULD NOT accept "retry_config" in response to a connection
initiated in response to a "retry_config".  Sending a "retry_config"
in this situation is a signal that the server is misconfigured, e.g.,
the server might have multiple inconsistent configurations so that the
client reached a node with configuration A in the first connection and
a node with configuration B in the second. Note that this guidance
does not apply to the cases in the previous paragraph where the server
has securely disabled ECH.<a href="#section-6.1.6-7" class="pilcrow">¶</a></p>
<p id="section-6.1.6-8">If a client does not retry, it MUST report an error to the calling
application.<a href="#section-6.1.6-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="auth-public-name">
<section id="section-6.1.7">
          <h4 id="name-authenticating-for-the-publ">
<a href="#section-6.1.7" class="section-number selfRef">6.1.7. </a><a href="#name-authenticating-for-the-publ" class="section-name selfRef">Authenticating for the Public Name</a>
          </h4>
<p id="section-6.1.7-1">When the server rejects ECH, it continues with the handshake using the plaintext
"server_name" extension instead (see <a href="#server-behavior" class="auto internal xref">Section 7</a>). Clients that offer
ECH then authenticate the connection with the public name, as follows:<a href="#section-6.1.7-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1.7-2.1">
              <p id="section-6.1.7-2.1.1">The client MUST verify that the certificate is valid for
ECHConfig.contents.public_name. If invalid, it MUST abort the connection with
the appropriate alert.<a href="#section-6.1.7-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.1.7-2.2">
              <p id="section-6.1.7-2.2.1">If the server requests a client certificate, the client MUST respond with an
empty Certificate message, denoting no client certificate.<a href="#section-6.1.7-2.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-6.1.7-3">In verifying the client-facing server certificate, the client MUST interpret
the public name as a DNS-based reference identity. Clients that incorporate DNS
names and IP addresses into the same syntax (e.g. <span>[<a href="#RFC3986" class="cite xref">RFC3986</a>], <a href="https://rfc-editor.org/rfc/rfc3986#section-7.4" class="relref">Section 7.4</a></span> and
<span>[<a href="#WHATWG-IPV4" class="cite xref">WHATWG-IPV4</a>]</span>) MUST reject names that would be interpreted as IPv4 addresses.
Clients that enforce this by checking ECHConfig.contents.public_name do not need
to repeat the check at this layer.<a href="#section-6.1.7-3" class="pilcrow">¶</a></p>
<p id="section-6.1.7-4">Note that authenticating a connection for the public name does not authenticate
it for the origin. The TLS implementation MUST NOT report such connections as
successful to the application. It additionally MUST ignore all session tickets
and session IDs presented by the server. These connections are only used to
trigger retries, as described in <a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a>. This may be implemented, for
instance, by reporting a failed connection with a dedicated error code.<a href="#section-6.1.7-4" class="pilcrow">¶</a></p>
<p id="section-6.1.7-5">Prior to attempting a connection, a client SHOULD validate the <code>ECHConfig</code> to
ensure that the public_name can be authenticated.  Clients SHOULD ignore any
<code>ECHConfig</code> structure with a public_name that is not a valid host name in
preferred name syntax (see <span><a href="https://rfc-editor.org/rfc/rfc8499#section-2" class="relref">Section 2</a> of [<a href="#DNS-TERMS" class="cite xref">DNS-TERMS</a>]</span>).  That is, to be
valid, the public_name needs to be a dot-separated sequence of LDH labels, as
defined in <span><a href="https://rfc-editor.org/rfc/rfc5890#section-2.3.1" class="relref">Section 2.3.1</a> of [<a href="#RFC5890" class="cite xref">RFC5890</a>]</span>, where:<a href="#section-6.1.7-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1.7-6.1">
              <p id="section-6.1.7-6.1.1">the sequence does not begin or end with an ASCII dot, and<a href="#section-6.1.7-6.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.1.7-6.2">
              <p id="section-6.1.7-6.2.1">all labels are at most 63 octets.<a href="#section-6.1.7-6.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-6.1.7-7">Clients additionally SHOULD ignore the structure if the final LDH
label either consists of all ASCII digits (i.e. '0' through '9') or is
"0x" or "0X" followed by some, possibly empty, sequence of ASCII
hexadecimal digits (i.e. '0' through '9', 'a' through 'f', and 'A'
through 'F'). This avoids public_name values that may be interpreted
as IPv4 literals.<a href="#section-6.1.7-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="impact-of-retry-on-future-connections">
<section id="section-6.1.8">
          <h4 id="name-impact-of-retry-on-future-c">
<a href="#section-6.1.8" class="section-number selfRef">6.1.8. </a><a href="#name-impact-of-retry-on-future-c" class="section-name selfRef">Impact of Retry on Future Connections</a>
          </h4>
<p id="section-6.1.8-1">Clients MAY use information learned from a rejected ECH for future
connections to avoid repeatedly connecting to the same server and
being forced to retry. However, they MUST handle ECH rejection for
those connections as if it were a fresh connection, rather than
enforcing the single retry limit from <a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a>. The reason
for this requirement is that if the server sends a "retry_config"
and then immediately rejects the resulting connection, it is
most likely misconfigured. However, if the server sends a "retry_config"
and then the client tries to use that to connect some time
later, it is possible that the server has been forced to
change its configuration again and is now trying to recover.<a href="#section-6.1.8-1" class="pilcrow">¶</a></p>
<p id="section-6.1.8-2">Any persisted information MUST be associated with the ECHConfig source
used to bootstrap the connection, such as a DNS SVCB ServiceMode record
<span>[<a href="#ECH-IN-DNS" class="cite xref">ECH-IN-DNS</a>]</span>. Clients MUST limit any sharing of persisted ECH-related
state to connections that use the same ECHConfig source. Otherwise, it
might become possible for the client to have the wrong public name for
the server, making recovery impossible.<a href="#section-6.1.8-2" class="pilcrow">¶</a></p>
<p id="section-6.1.8-3">ECHConfigs learned from ECH rejection can be used as a tracking
vector. Clients SHOULD impose the same lifetime and scope restrictions
that they apply to other server-based
tracking vectors such as PSKs.<a href="#section-6.1.8-3" class="pilcrow">¶</a></p>
<p id="section-6.1.8-4">In general, the safest way for clients to minimize ECH retries is to
comply with any freshness rules (e.g., DNS TTLs) imposed by the ECH
configuration.<a href="#section-6.1.8-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="grease-ech">
<section id="section-6.2">
        <h3 id="name-grease-ech">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-grease-ech" class="section-name selfRef">GREASE ECH</a>
        </h3>
<p id="section-6.2-1">If the client attempts to connect to a server and does not have an ECHConfig
structure available for the server, it SHOULD send a GREASE <span>[<a href="#RFC8701" class="cite xref">RFC8701</a>]</span>
"encrypted_client_hello" extension in the first ClientHello as follows:<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.2-2.1">
            <p id="section-6.2-2.1.1">Set the <code>config_id</code> field to a random byte.<a href="#section-6.2-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.2-2.2">
            <p id="section-6.2-2.2.1">Set the <code>cipher_suite</code> field to a supported HpkeSymmetricCipherSuite. The
selection SHOULD vary to exercise all supported configurations, but MAY be
held constant for successive connections to the same server in the same
session.<a href="#section-6.2-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.2-2.3">
            <p id="section-6.2-2.3.1">Set the <code>enc</code> field to a randomly-generated valid encapsulated public key
output by the HPKE KEM.<a href="#section-6.2-2.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.2-2.4">
            <p id="section-6.2-2.4.1">Set the <code>payload</code> field to a randomly-generated string of L+C bytes, where C
is the ciphertext expansion of the selected AEAD scheme and L is the size of
the EncodedClientHelloInner the client would compute when offering ECH, padded
according to <a href="#padding" class="auto internal xref">Section 6.1.3</a>.<a href="#section-6.2-2.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.2-3">If sending a second ClientHello in response to a HelloRetryRequest, the
client copies the entire "encrypted_client_hello" extension from the first
ClientHello. The identical value will reveal to an observer that the value of
"encrypted_client_hello" was fake, but this only occurs if there is a
HelloRetryRequest.<a href="#section-6.2-3" class="pilcrow">¶</a></p>
<p id="section-6.2-4">If the server sends an "encrypted_client_hello" extension in either
HelloRetryRequest or EncryptedExtensions, the client MUST check the extension
syntactically and abort the connection with a "decode_error" alert if it is
invalid. It otherwise ignores the extension. It MUST NOT save the
"retry_configs" value in EncryptedExtensions.<a href="#section-6.2-4" class="pilcrow">¶</a></p>
<p id="section-6.2-5">Offering a GREASE extension is not considered offering an encrypted ClientHello
for purposes of requirements in <a href="#real-ech" class="auto internal xref">Section 6.1</a>. In particular, the client
MAY offer to resume sessions established without ECH.<a href="#section-6.2-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="server-behavior">
<section id="section-7">
      <h2 id="name-server-behavior">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-server-behavior" class="section-name selfRef">Server Behavior</a>
      </h2>
<p id="section-7-1">As described in <a href="#topologies" class="auto internal xref">Section 3.1</a>, servers can play two roles, either as
the client-facing server or as the back-end server.
Depending on the server role, the <code>ECHClientHello</code> will be different:<a href="#section-7-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7-2.1">
          <p id="section-7-2.1.1">A client-facing server expects a <code>ECHClientHello.type</code> of <code>outer</code>, and
proceeds as described in <a href="#client-facing-server" class="auto internal xref">Section 7.1</a> to extract a
ClientHelloInner, if available.<a href="#section-7-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-7-2.2">
          <p id="section-7-2.2.1">A backend server expects a <code>ECHClientHello.type</code> of <code>inner</code>, and
proceeds as described in <a href="#backend-server" class="auto internal xref">Section 7.2</a>.<a href="#section-7-2.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-7-3">In split mode, a client-facing server which receives a <code>ClientHello</code>
with <code>ECHClientHello.type</code> of <code>inner</code> MUST abort with an
"illegal_parameter" alert. Similarly, in split mode, a backend server
which receives a <code>ClientHello</code> with <code>ECHClientHello.type</code> of <code>outer</code>
MUST abort with an "illegal_parameter" alert.<a href="#section-7-3" class="pilcrow">¶</a></p>
<p id="section-7-4">In shared mode, a server plays both roles, first decrypting the
<code>ClientHelloOuter</code> and then using the contents of the
<code>ClientHelloInner</code>.  A shared mode server which receives a
<code>ClientHello</code> with <code>ECHClientHello.type</code> of <code>inner</code> MUST abort with an
"illegal_parameter" alert, because such a <code>ClientHello</code> should never
be received directly from the network.<a href="#section-7-4" class="pilcrow">¶</a></p>
<p id="section-7-5">If <code>ECHClientHello.type</code> is not a valid <code>ECHClientHelloType</code>, then
the server MUST abort with an "illegal_parameter" alert.<a href="#section-7-5" class="pilcrow">¶</a></p>
<p id="section-7-6">If the "encrypted_client_hello" is not present, then the server completes the
handshake normally, as described in <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>.<a href="#section-7-6" class="pilcrow">¶</a></p>
<div id="client-facing-server">
<section id="section-7.1">
        <h3 id="name-client-facing-server">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-client-facing-server" class="section-name selfRef">Client-Facing Server</a>
        </h3>
<p id="section-7.1-1">Upon receiving an "encrypted_client_hello" extension in an initial
ClientHello, the client-facing server determines if it will accept ECH, prior
to negotiating any other TLS parameters. Note that successfully decrypting the
extension will result in a new ClientHello to process, so even the client's TLS
version preferences may have changed.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1-2">First, the server collects a set of candidate ECHConfig values. This list is
determined by one of the two following methods:<a href="#section-7.1-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-7.1-3">
<li id="section-7.1-3.1">
            <p id="section-7.1-3.1.1">Compare ECHClientHello.config_id against identifiers of each known ECHConfig
and select the ones that match, if any, as candidates.<a href="#section-7.1-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-7.1-3.2">
            <p id="section-7.1-3.2.1">Collect all known ECHConfig values as candidates, with trial decryption
below determining the final selection.<a href="#section-7.1-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-7.1-4">Some uses of ECH, such as local discovery mode, may randomize the
ECHClientHello.config_id since it can be used as a tracking vector. In such
cases, the second method SHOULD be used for matching the ECHClientHello to a
known ECHConfig. See <a href="#ignored-configs" class="auto internal xref">Section 10.4</a>. Unless specified by the application
profile or otherwise externally configured, implementations MUST use the first
method.<a href="#section-7.1-4" class="pilcrow">¶</a></p>
<p id="section-7.1-5">The server then iterates over the candidate ECHConfig values, attempting to
decrypt the "encrypted_client_hello" extension as follows.<a href="#section-7.1-5" class="pilcrow">¶</a></p>
<p id="section-7.1-6">The server verifies that the ECHConfig supports the cipher suite indicated by
the ECHClientHello.cipher_suite and that the version of ECH indicated by the
client matches the ECHConfig.version. If not, the server continues to the next
candidate ECHConfig.<a href="#section-7.1-6" class="pilcrow">¶</a></p>
<p id="section-7.1-7">Next, the server decrypts ECHClientHello.payload, using the private key skR
corresponding to ECHConfig, as follows:<a href="#section-7.1-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.1-8">
<pre>
    context = SetupBaseR(ECHClientHello.enc, skR,
                         "tls ech" || 0x00 || ECHConfig)
    EncodedClientHelloInner = context.Open(ClientHelloOuterAAD,
                                         ECHClientHello.payload)
</pre><a href="#section-7.1-8" class="pilcrow">¶</a>
</div>
<p id="section-7.1-9">ClientHelloOuterAAD is computed from ClientHelloOuter as described in
<a href="#authenticating-outer" class="auto internal xref">Section 5.2</a>. The <code>info</code> parameter to SetupBaseR is the
concatenation "tls ech", a zero byte, and the serialized ECHConfig. If
decryption fails, the server continues to the next candidate ECHConfig.
Otherwise, the server reconstructs ClientHelloInner from
EncodedClientHelloInner, as described in <a href="#encoding-inner" class="auto internal xref">Section 5.1</a>. It then stops
iterating over the candidate ECHConfig values.<a href="#section-7.1-9" class="pilcrow">¶</a></p>
<p id="section-7.1-10">Once the server has chosen the correct ECHConfig, it MAY verify that the value
in the ClientHelloOuter "server_name" extension matches the value of
ECHConfig.contents.public_name, and abort with an "illegal_parameter" alert if
these do not match. This optional check allows the server to limit ECH
connections to only use the public SNI values advertised in its ECHConfigs.
The server MUST be careful not to unnecessarily reject connections if the same
ECHConfig id or keypair is used in multiple ECHConfigs with distinct public
names.<a href="#section-7.1-10" class="pilcrow">¶</a></p>
<p id="section-7.1-11">Upon determining the ClientHelloInner, the client-facing server checks that the
message includes a well-formed "encrypted_client_hello" extension of type
<code>inner</code> and that it does not offer TLS 1.2 or below. If either of these checks
fails, the client-facing server MUST abort with an "illegal_parameter" alert.<a href="#section-7.1-11" class="pilcrow">¶</a></p>
<p id="section-7.1-12">If these checks succeed, the client-facing server then forwards the
ClientHelloInner to the appropriate backend server, which proceeds as in
<a href="#backend-server" class="auto internal xref">Section 7.2</a>. If the backend server responds with a HelloRetryRequest, the
client-facing server forwards it, decrypts the client's second ClientHelloOuter
using the procedure in <a href="#client-facing-server-hrr" class="auto internal xref">Section 7.1.1</a>, and forwards the resulting
second ClientHelloInner. The client-facing server forwards all other TLS
messages between the client and backend server unmodified.<a href="#section-7.1-12" class="pilcrow">¶</a></p>
<p id="section-7.1-13">Otherwise, if all candidate ECHConfig values fail to decrypt the extension, the
client-facing server MUST ignore the extension and proceed with the connection
using ClientHelloOuter, with the following modifications:<a href="#section-7.1-13" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.1-14.1">
            <p id="section-7.1-14.1.1">If sending a HelloRetryRequest, the server MAY include an
"encrypted_client_hello" extension with a payload of 8 random bytes; see
<a href="#dont-stick-out" class="auto internal xref">Section 10.10.4</a> for details.<a href="#section-7.1-14.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-7.1-14.2">
            <p id="section-7.1-14.2.1">If the server is configured with any ECHConfigs, it MUST include the
"encrypted_client_hello" extension in its EncryptedExtensions with the
"retry_configs" field set to one or more ECHConfig structures with up-to-date
keys. Servers MAY supply multiple ECHConfig values of different versions.
This allows a server to support multiple versions at once.<a href="#section-7.1-14.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-7.1-15">Note that decryption failure could indicate a GREASE ECH extension (see
<a href="#grease-ech" class="auto internal xref">Section 6.2</a>), so it is necessary for servers to proceed with the connection
and rely on the client to abort if ECH was required. In particular, the
unrecognized value alone does not indicate a misconfigured ECH advertisement
(<a href="#misconfiguration" class="auto internal xref">Section 8.1.1</a>). Instead, servers can measure occurrences of the
"ech_required" alert to detect this case.<a href="#section-7.1-15" class="pilcrow">¶</a></p>
<div id="client-facing-server-hrr">
<section id="section-7.1.1">
          <h4 id="name-sending-helloretryrequest">
<a href="#section-7.1.1" class="section-number selfRef">7.1.1. </a><a href="#name-sending-helloretryrequest" class="section-name selfRef">Sending HelloRetryRequest</a>
          </h4>
<p id="section-7.1.1-1">After sending or forwarding a HelloRetryRequest, the client-facing server does
not repeat the steps in <a href="#client-facing-server" class="auto internal xref">Section 7.1</a> with the second
ClientHelloOuter. Instead, it continues with the ECHConfig selection from the
first ClientHelloOuter as follows:<a href="#section-7.1.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1.1-2">If the client-facing server accepted ECH, it checks the second ClientHelloOuter
also contains the "encrypted_client_hello" extension. If not, it MUST abort the
handshake with a "missing_extension" alert. Otherwise, it checks that
ECHClientHello.cipher_suite and ECHClientHello.config_id are unchanged, and that
ECHClientHello.enc is empty. If not, it MUST abort the handshake with an
"illegal_parameter" alert.<a href="#section-7.1.1-2" class="pilcrow">¶</a></p>
<p id="section-7.1.1-3">Finally, it decrypts the new ECHClientHello.payload as a second message with the
previous HPKE context:<a href="#section-7.1.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.1.1-4">
<pre>
    EncodedClientHelloInner = context.Open(ClientHelloOuterAAD,
                                         ECHClientHello.payload)
</pre><a href="#section-7.1.1-4" class="pilcrow">¶</a>
</div>
<p id="section-7.1.1-5">ClientHelloOuterAAD is computed as described in <a href="#authenticating-outer" class="auto internal xref">Section 5.2</a>, but
using the second ClientHelloOuter. If decryption fails, the client-facing
server MUST abort the handshake with a "decrypt_error" alert. Otherwise, it
reconstructs the second ClientHelloInner from the new EncodedClientHelloInner
as described in <a href="#encoding-inner" class="auto internal xref">Section 5.1</a>, using the second ClientHelloOuter for
any referenced extensions.<a href="#section-7.1.1-5" class="pilcrow">¶</a></p>
<p id="section-7.1.1-6">The client-facing server then forwards the resulting ClientHelloInner to the
backend server. It forwards all subsequent TLS messages between the client and
backend server unmodified.<a href="#section-7.1.1-6" class="pilcrow">¶</a></p>
<p id="section-7.1.1-7">If the client-facing server rejected ECH, or if the first ClientHello did not
include an "encrypted_client_hello" extension, the client-facing server
proceeds with the connection as usual. The server does not decrypt the
second ClientHello's ECHClientHello.payload value, if there is one.
Moreover, if the server is configured with any ECHConfigs, it MUST include the
"encrypted_client_hello" extension in its EncryptedExtensions with the
"retry_configs" field set to one or more ECHConfig structures with up-to-date
keys, as described in <a href="#client-facing-server" class="auto internal xref">Section 7.1</a>.<a href="#section-7.1.1-7" class="pilcrow">¶</a></p>
<p id="section-7.1.1-8">Note that a client-facing server that forwards the first ClientHello cannot
include its own "cookie" extension if the backend server sends a
HelloRetryRequest.  This means that the client-facing server either needs to
maintain state for such a connection or it needs to coordinate with the backend
server to include any information it requires to process the second ClientHello.<a href="#section-7.1.1-8" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="backend-server">
<section id="section-7.2">
        <h3 id="name-backend-server">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-backend-server" class="section-name selfRef">Backend Server</a>
        </h3>
<p id="section-7.2-1">Upon receipt of an "encrypted_client_hello" extension of type <code>inner</code> in a
ClientHello, if the backend server negotiates TLS 1.3 or higher, then it MUST
confirm ECH acceptance to the client by computing its ServerHello as described
here.<a href="#section-7.2-1" class="pilcrow">¶</a></p>
<p id="section-7.2-2">The backend server embeds in ServerHello.random a string derived from the inner
handshake. It begins by computing its ServerHello as usual, except the last 8
bytes of ServerHello.random are set to zero. It then computes the transcript
hash for ClientHelloInner up to and including the modified ServerHello, as
described in <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-4.4.1" class="relref">Section 4.4.1</a></span>. Let transcript_ech_conf denote the
output. Finally, the backend server overwrites the last 8 bytes of the
ServerHello.random with the following string:<a href="#section-7.2-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.2-3">
<pre>
   accept_confirmation = HKDF-Expand-Label(
      HKDF-Extract(0, ClientHelloInner.random),
      "ech accept confirmation",
      transcript_ech_conf,
      8)
</pre><a href="#section-7.2-3" class="pilcrow">¶</a>
</div>
<p id="section-7.2-4">where HKDF-Expand-Label is defined in <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-7.1" class="relref">Section 7.1</a></span>, "0" indicates a
string of Hash.length bytes set to zero, and Hash is the hash function used to
compute the transcript hash. In DTLS, the modified version of HKDF-Expand-Label
defined in <span>[<a href="#RFC9147" class="cite xref">RFC9147</a>], <a href="https://rfc-editor.org/rfc/rfc9147#section-5.9" class="relref">Section 5.9</a></span> is used instead.<a href="#section-7.2-4" class="pilcrow">¶</a></p>
<p id="section-7.2-5">The backend server MUST NOT perform this operation if it negotiated TLS 1.2 or
below. Note that doing so would overwrite the downgrade signal for TLS 1.3 (see
<span>[<a href="#RFC8446" class="cite xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-4.1.3" class="relref">Section 4.1.3</a></span>).<a href="#section-7.2-5" class="pilcrow">¶</a></p>
<div id="backend-server-hrr">
<section id="section-7.2.1">
          <h4 id="name-sending-helloretryrequest-2">
<a href="#section-7.2.1" class="section-number selfRef">7.2.1. </a><a href="#name-sending-helloretryrequest-2" class="section-name selfRef">Sending HelloRetryRequest</a>
          </h4>
<p id="section-7.2.1-1">When the backend server sends HelloRetryRequest in response to the ClientHello,
it similarly confirms ECH acceptance by adding a confirmation signal to its
HelloRetryRequest. But instead of embedding the signal in the
HelloRetryRequest.random (the value of which is specified by <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>), it
sends the signal in an extension.<a href="#section-7.2.1-1" class="pilcrow">¶</a></p>
<p id="section-7.2.1-2">The backend server begins by computing HelloRetryRequest as usual, except that
it also contains an "encrypted_client_hello" extension with a payload of 8 zero
bytes. It then computes the transcript hash for the first ClientHelloInner,
denoted ClientHelloInner1, up to and including the modified HelloRetryRequest.
Let transcript_hrr_ech_conf denote the output. Finally, the backend server
overwrites the payload of the "encrypted_client_hello" extension with the
following string:<a href="#section-7.2.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-7.2.1-3">
<pre>
   hrr_accept_confirmation = HKDF-Expand-Label(
      HKDF-Extract(0, ClientHelloInner1.random),
      "hrr ech accept confirmation",
      transcript_hrr_ech_conf,
      8)
</pre><a href="#section-7.2.1-3" class="pilcrow">¶</a>
</div>
<p id="section-7.2.1-4">In the subsequent ServerHello message, the backend server sends the
accept_confirmation value as described in <a href="#backend-server" class="auto internal xref">Section 7.2</a>.<a href="#section-7.2.1-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="deployment">
<section id="section-8">
      <h2 id="name-deployment-considerations">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-deployment-considerations" class="section-name selfRef">Deployment Considerations</a>
      </h2>
<p id="section-8-1">The design of ECH as specified in this document necessarily requires changes
to client, client-facing server, and backend server. Coordination between
client-facing and backend server requires care, as deployment mistakes
can lead to compatibility issues. These are discussed in <a href="#compat-issues" class="auto internal xref">Section 8.1</a>.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">Beyond coordination difficulties, ECH deployments may also induce challenges
for use cases of information that ECH protects. In particular,
use cases which depend on this unencrypted information may no longer work
as desired. This is elaborated upon in <a href="#no-sni" class="auto internal xref">Section 8.2</a>.<a href="#section-8-2" class="pilcrow">¶</a></p>
<div id="compat-issues">
<section id="section-8.1">
        <h3 id="name-compatibility-issues">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-compatibility-issues" class="section-name selfRef">Compatibility Issues</a>
        </h3>
<p id="section-8.1-1">Unlike most TLS extensions, placing the SNI value in an ECH extension is not
interoperable with existing servers, which expect the value in the existing
plaintext extension. Thus server operators SHOULD ensure servers understand a
given set of ECH keys before advertising them. Additionally, servers SHOULD
retain support for any previously-advertised keys for the duration of their
validity.<a href="#section-8.1-1" class="pilcrow">¶</a></p>
<p id="section-8.1-2">However, in more complex deployment scenarios, this may be difficult to fully
guarantee. Thus this protocol was designed to be robust in case of
inconsistencies between systems that advertise ECH keys and servers, at the cost
of extra round-trips due to a retry. Two specific scenarios are detailed below.<a href="#section-8.1-2" class="pilcrow">¶</a></p>
<div id="misconfiguration">
<section id="section-8.1.1">
          <h4 id="name-misconfiguration-and-deploy">
<a href="#section-8.1.1" class="section-number selfRef">8.1.1. </a><a href="#name-misconfiguration-and-deploy" class="section-name selfRef">Misconfiguration and Deployment Concerns</a>
          </h4>
<p id="section-8.1.1-1">It is possible for ECH advertisements and servers to become inconsistent. This
may occur, for instance, from DNS misconfiguration, caching issues, or an
incomplete rollout in a multi-server deployment. This may also occur if a server
loses its ECH keys, or if a deployment of ECH must be rolled back on the server.<a href="#section-8.1.1-1" class="pilcrow">¶</a></p>
<p id="section-8.1.1-2">The retry mechanism repairs inconsistencies, provided the server is
authoritative for the public name. If server and advertised keys mismatch, the
server will reject ECH and respond with "retry_configs". If the server does
not understand
the "encrypted_client_hello" extension at all, it will ignore it as required by
<span><a href="https://rfc-editor.org/rfc/rfc8446#section-4.1.2" class="relref">Section 4.1.2</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>. Provided the server can present a certificate
valid for the public name, the client can safely retry with updated settings,
as described in <a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a>.<a href="#section-8.1.1-2" class="pilcrow">¶</a></p>
<p id="section-8.1.1-3">Unless ECH is disabled as a result of successfully establishing a connection to
the public name, the client MUST NOT fall back to using unencrypted
ClientHellos, as this allows a network attacker to disclose the contents of this
ClientHello, including the SNI. It MAY attempt to use another server from the
DNS results, if one is provided.<a href="#section-8.1.1-3" class="pilcrow">¶</a></p>
<p id="section-8.1.1-4">In order to ensure that the retry mechanism works successfully servers
SHOULD ensure that every endpoint which might receive a TLS connection
is provisioned with an appropriate certificate for the public name.
This is especially important during periods of server reconfiguration
when different endpoints might have different configurations.<a href="#section-8.1.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="middleboxes">
<section id="section-8.1.2">
          <h4 id="name-middleboxes">
<a href="#section-8.1.2" class="section-number selfRef">8.1.2. </a><a href="#name-middleboxes" class="section-name selfRef">Middleboxes</a>
          </h4>
<p id="section-8.1.2-1">The requirements in <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-9.3" class="relref">Section 9.3</a></span> which require proxies to
act as conforming TLS client and server provide interoperability
with TLS-terminating proxies even in cases where the server supports
ECH but the proxy does not, as detailed below.<a href="#section-8.1.2-1" class="pilcrow">¶</a></p>
<p id="section-8.1.2-2">The proxy must ignore unknown parameters, and
generate its own ClientHello containing only parameters it understands. Thus,
when presenting a certificate to the client or sending a ClientHello to the
server, the proxy will act as if connecting to the ClientHelloOuter
server_name, which SHOULD match the public name (see <a href="#real-ech" class="auto internal xref">Section 6.1</a>), without
echoing the "encrypted_client_hello" extension.<a href="#section-8.1.2-2" class="pilcrow">¶</a></p>
<p id="section-8.1.2-3">Depending on whether the client is configured to accept the proxy's certificate
as authoritative for the public name, this may trigger the retry logic described
in <a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a> or result in a connection failure. A proxy which is not
authoritative for the public name cannot forge a signal to disable ECH.<a href="#section-8.1.2-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="no-sni">
<section id="section-8.2">
        <h3 id="name-deployment-impact">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-deployment-impact" class="section-name selfRef">Deployment Impact</a>
        </h3>
<p id="section-8.2-1">Some use cases which depend on information ECH encrypts may break with the
deployment of ECH. The extent of breakage depends on a number of external
factors, including, for example, whether ECH can be disabled, whether or not
the party disabling ECH is trusted to do so, and whether or not client
implementations will fall back to TLS without ECH in the event of disablement.<a href="#section-8.2-1" class="pilcrow">¶</a></p>
<p id="section-8.2-2">Depending on implementation details and deployment settings, use cases
which depend on plaintext TLS information may require fundamentally different
approaches to continue working. For example, in managed enterprise settings,
one approach may be to disable ECH entirely via group policy and for
client implementations to honor this action.<a href="#section-8.2-2" class="pilcrow">¶</a></p>
<p id="section-8.2-3">In the context of <a href="#rejected-ech" class="auto internal xref">Section 6.1.6</a>, another approach may be to
intercept and decrypt client TLS connections. The feasibility of alternative
solutions is specific to individual deployments.<a href="#section-8.2-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="compliance">
<section id="section-9">
      <h2 id="name-compliance-requirements">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-compliance-requirements" class="section-name selfRef">Compliance Requirements</a>
      </h2>
<p id="section-9-1">In the absence of an application profile standard specifying otherwise,
a compliant ECH application MUST implement the following HPKE cipher suite:<a href="#section-9-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9-2.1">
          <p id="section-9-2.1.1">KEM: DHKEM(X25519, HKDF-SHA256) (see <span><a href="https://rfc-editor.org/rfc/rfc9180#section-7.1" class="relref">Section 7.1</a> of [<a href="#HPKE" class="cite xref">HPKE</a>]</span>)<a href="#section-9-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-9-2.2">
          <p id="section-9-2.2.1">KDF: HKDF-SHA256 (see <span><a href="https://rfc-editor.org/rfc/rfc9180#section-7.2" class="relref">Section 7.2</a> of [<a href="#HPKE" class="cite xref">HPKE</a>]</span>)<a href="#section-9-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-9-2.3">
          <p id="section-9-2.3.1">AEAD: AES-128-GCM (see <span><a href="https://rfc-editor.org/rfc/rfc9180#section-7.3" class="relref">Section 7.3</a> of [<a href="#HPKE" class="cite xref">HPKE</a>]</span>)<a href="#section-9-2.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="security-considerations">
<section id="section-10">
      <h2 id="name-security-considerations">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-10-1">This section contains security considerations for ECH.<a href="#section-10-1" class="pilcrow">¶</a></p>
<div id="goals">
<section id="section-10.1">
        <h3 id="name-security-and-privacy-goals">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-security-and-privacy-goals" class="section-name selfRef">Security and Privacy Goals</a>
        </h3>
<p id="section-10.1-1">ECH considers two types of attackers: passive and active. Passive attackers can
read packets from the network, but they cannot perform any sort of active
behavior such as probing servers or querying DNS. A middlebox that filters based
on plaintext packet contents is one example of a passive attacker. In contrast,
active attackers can also write packets into the network for malicious purposes,
such as interfering with existing connections, probing servers, and querying
DNS. In short, an active attacker corresponds to the conventional threat model
for TLS 1.3 <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>.<a href="#section-10.1-1" class="pilcrow">¶</a></p>
<p id="section-10.1-2">Passive and active attackers can exist anywhere in the network, including
between the client and client-facing server, as well as between the
client-facing and backend servers when running ECH in Split Mode. However,
for Split Mode in particular, ECH makes two additional assumptions:<a href="#section-10.1-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-10.1-3">
<li id="section-10.1-3.1">
            <p id="section-10.1-3.1.1">The channel between each client-facing and each backend server is
authenticated such that the backend server only accepts messages from trusted
client-facing servers. The exact mechanism for establishing this authenticated
channel is out of scope for this document.<a href="#section-10.1-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-10.1-3.2">
            <p id="section-10.1-3.2.1">The attacker cannot correlate messages between client and client-facing
server with messages between client-facing and backend server. Such correlation
could allow an attacker to link information unique to a backend server, such as
their server name or IP address, with a client's encrypted ClientHelloInner.
Correlation could occur through timing analysis of messages across the
client-facing server, or via examining the contents of messages sent between
client-facing and backend servers. The exact mechanism for preventing this sort
of correlation is out of scope for this document.<a href="#section-10.1-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-10.1-4">Given this threat model, the primary goals of ECH are as follows.<a href="#section-10.1-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-10.1-5">
<li id="section-10.1-5.1">
            <p id="section-10.1-5.1.1">Security preservation. Use of ECH does not weaken the security properties of
TLS without ECH.<a href="#section-10.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-10.1-5.2">
            <p id="section-10.1-5.2.1">Handshake privacy. TLS connection establishment to a host within an
anonymity set is indistinguishable from a connection to any other host
within the anonymity set. (The anonymity set is defined in
<a href="#intro" class="auto internal xref">Section 1</a>.)<a href="#section-10.1-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-10.1-5.3">
            <p id="section-10.1-5.3.1">Downgrade resistance. An attacker cannot downgrade a connection that
attempts to use ECH to one that does not use ECH.<a href="#section-10.1-5.3.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-10.1-6">These properties were formally proven in <span>[<a href="#ECH-Analysis" class="cite xref">ECH-Analysis</a>]</span>.<a href="#section-10.1-6" class="pilcrow">¶</a></p>
<p id="section-10.1-7">With regards to handshake privacy, client-facing server configuration
determines the size of the anonymity set. For example, if a client-facing
server uses distinct ECHConfig values for each host, then each anonymity set
has size k = 1. Client-facing servers SHOULD deploy ECH in such a way so as to
maximize the size of the anonymity set where possible. This means client-facing
servers should use the same ECHConfig for as many hosts as possible. An
attacker can distinguish two hosts that have different ECHConfig values based
on the ECHClientHello.config_id value.<a href="#section-10.1-7" class="pilcrow">¶</a></p>
<p id="section-10.1-8">This also means public information in a TLS handshake should be
consistent across hosts. For example, if a client-facing server
services many backend origin hosts, only one of which supports some
cipher suite, it may be possible to identify that host based on the
contents of unencrypted handshake message. Similarly, if a backend
origin reuses KeyShare values, then that provides a unique identifier
for that server.<a href="#section-10.1-8" class="pilcrow">¶</a></p>
<p id="section-10.1-9">Beyond these primary security and privacy goals, ECH also aims to hide, to some
extent, the fact that it is being used at all. Specifically, the GREASE ECH
extension described in <a href="#grease-ech" class="auto internal xref">Section 6.2</a> does not change the security properties of
the TLS handshake at all. Its goal is to provide "cover" for the real ECH
protocol (<a href="#real-ech" class="auto internal xref">Section 6.1</a>), as a means of addressing the "do not stick out"
requirements of <span>[<a href="#RFC8744" class="cite xref">RFC8744</a>]</span>. See <a href="#dont-stick-out" class="auto internal xref">Section 10.10.4</a> for details.<a href="#section-10.1-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="plaintext-dns">
<section id="section-10.2">
        <h3 id="name-unauthenticated-and-plainte">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-unauthenticated-and-plainte" class="section-name selfRef">Unauthenticated and Plaintext DNS</a>
        </h3>
<p id="section-10.2-1">In comparison to <span>[<a href="#I-D.kazuho-protected-sni" class="cite xref">I-D.kazuho-protected-sni</a>]</span>, wherein DNS Resource Records are
signed via a server private key, ECH records have no authenticity or provenance
information. This means that any attacker which can inject DNS responses or
poison DNS caches, which is a common scenario in client access networks, can
supply clients with fake ECH records (so that the client encrypts data to them)
or strip the ECH record from the response. However, in the face of an attacker
that controls DNS, no encryption scheme can work because the attacker can
replace the IP address, thus blocking client connections, or substitute a
unique IP address which is 1:1 with the DNS name that was looked up (modulo DNS
wildcards). Thus, allowing the ECH records in the clear does not make the
situation significantly worse.<a href="#section-10.2-1" class="pilcrow">¶</a></p>
<p id="section-10.2-2">Clearly, DNSSEC (if the client validates and hard fails) is a defense
against this form of attack, but encrypted DNS transport is also a
defense against DNS attacks by attackers on the local network, which
is a common case where ClientHello and SNI encryption are
desired. Moreover, as noted in the introduction, SNI encryption is
less useful without encryption of DNS queries in transit mechanisms.<a href="#section-10.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="client-tracking">
<section id="section-10.3">
        <h3 id="name-client-tracking">
<a href="#section-10.3" class="section-number selfRef">10.3. </a><a href="#name-client-tracking" class="section-name selfRef">Client Tracking</a>
        </h3>
<p id="section-10.3-1">A malicious client-facing server could distribute unique, per-client ECHConfig
structures as a way of tracking clients across subsequent connections. On-path
adversaries which know about these unique keys could also track clients in this
way by observing TLS connection attempts.<a href="#section-10.3-1" class="pilcrow">¶</a></p>
<p id="section-10.3-2">The cost of this type of attack scales linearly with the desired number of
target clients. Moreover, DNS caching behavior makes targeting individual users
for extended periods of time, e.g., using per-client ECHConfig structures
delivered via HTTPS RRs with high TTLs, challenging. Clients can help mitigate
this problem by flushing any DNS or ECHConfig state upon changing networks.<a href="#section-10.3-2" class="pilcrow">¶</a></p>
<p id="section-10.3-3">ECHConfig rotation rate is also an issue for non-malicious servers,
which may want to rotate keys frequently to limit exposure if the key
is compromised. Rotating too frequently limits the client anonymity
set. In practice, servers with high load are the best candidates
to be client-facing servers and so anonymity sets will typically
be large even with fairly fast rotation intervals.<a href="#section-10.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ignored-configs">
<section id="section-10.4">
        <h3 id="name-ignored-configuration-ident">
<a href="#section-10.4" class="section-number selfRef">10.4. </a><a href="#name-ignored-configuration-ident" class="section-name selfRef">Ignored Configuration Identifiers and Trial Decryption</a>
        </h3>
<p id="section-10.4-1">Ignoring configuration identifiers may be useful in scenarios where clients and
client-facing servers do not want to reveal information about the client-facing
server in the "encrypted_client_hello" extension. In such settings, clients send
a randomly generated config_id in the ECHClientHello. Servers in these settings
must perform trial decryption since they cannot identify the client's chosen ECH
key using the config_id value. As a result, ignoring configuration
identifiers may exacerbate DoS attacks. Specifically, an adversary may send
malicious ClientHello messages, i.e., those which will not decrypt with any
known ECH key, in order to force wasteful decryption. Servers that support this
feature should, for example, implement some form of rate limiting mechanism to
limit the potential damage caused by such attacks.<a href="#section-10.4-1" class="pilcrow">¶</a></p>
<p id="section-10.4-2">Unless specified by the application using (D)TLS or externally configured,
implementations MUST NOT use this mode.<a href="#section-10.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="outer-clienthello">
<section id="section-10.5">
        <h3 id="name-outer-clienthello">
<a href="#section-10.5" class="section-number selfRef">10.5. </a><a href="#name-outer-clienthello" class="section-name selfRef">Outer ClientHello</a>
        </h3>
<p id="section-10.5-1">Any information that the client includes in the ClientHelloOuter is visible to
passive observers. The client SHOULD NOT send values in the ClientHelloOuter
which would reveal a sensitive ClientHelloInner property, such as the true
server name. It MAY send values associated with the public name in the
ClientHelloOuter.<a href="#section-10.5-1" class="pilcrow">¶</a></p>
<p id="section-10.5-2">In particular, some extensions require the client send a server-name-specific
value in the ClientHello. These values may reveal information about the
true server name. For example, the "cached_info" ClientHello extension
<span>[<a href="#RFC7924" class="cite xref">RFC7924</a>]</span> can contain the hash of a previously observed server certificate.
The client SHOULD NOT send values associated with the true server name in the
ClientHelloOuter. It MAY send such values in the ClientHelloInner.<a href="#section-10.5-2" class="pilcrow">¶</a></p>
<p id="section-10.5-3">A client may also use different preferences in different contexts. For example,
it may send different ALPN lists to different servers or in different
application contexts. A client that treats this context as sensitive SHOULD NOT
send context-specific values in ClientHelloOuter.<a href="#section-10.5-3" class="pilcrow">¶</a></p>
<p id="section-10.5-4">Values which are independent of the true server name, or other information the
client wishes to protect, MAY be included in ClientHelloOuter. If they match
the corresponding ClientHelloInner, they MAY be compressed as described in
<a href="#encoding-inner" class="auto internal xref">Section 5.1</a>. However, note that the payload length reveals information
about which extensions are compressed, so inner extensions which only sometimes
match the corresponding outer extension SHOULD NOT be compressed.<a href="#section-10.5-4" class="pilcrow">¶</a></p>
<p id="section-10.5-5">Clients MAY include additional extensions in ClientHelloOuter to avoid
signaling unusual behavior to passive observers, provided the choice of value
and value itself are not sensitive. See <a href="#dont-stick-out" class="auto internal xref">Section 10.10.4</a>.<a href="#section-10.5-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="inner-clienthello">
<section id="section-10.6">
        <h3 id="name-inner-clienthello">
<a href="#section-10.6" class="section-number selfRef">10.6. </a><a href="#name-inner-clienthello" class="section-name selfRef">Inner ClientHello</a>
        </h3>
<p id="section-10.6-1">Values which depend on the contents of ClientHelloInner, such as the
true server name, can influence how client-facing servers process this message.
In particular, timing side channels can reveal information about the contents
of ClientHelloInner. Implementations should take such side channels into
consideration when reasoning about the privacy properties that ECH provides.<a href="#section-10.6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="related-privacy-leaks">
<section id="section-10.7">
        <h3 id="name-related-privacy-leaks">
<a href="#section-10.7" class="section-number selfRef">10.7. </a><a href="#name-related-privacy-leaks" class="section-name selfRef">Related Privacy Leaks</a>
        </h3>
<p id="section-10.7-1">ECH requires encrypted DNS to be an effective privacy protection mechanism.
However, verifying the server's identity from the Certificate message,
particularly when using the X509 CertificateType, may result in additional
network traffic that may reveal the server identity. Examples of this traffic
may include requests for revocation information, such as OCSP or CRL traffic, or
requests for repository information, such as authorityInformationAccess. It may
also include implementation-specific traffic for additional information sources
as part of verification.<a href="#section-10.7-1" class="pilcrow">¶</a></p>
<p id="section-10.7-2">Implementations SHOULD avoid leaking information that may identify the server.
Even when sent over an encrypted transport, such requests may result in indirect
exposure of the server's identity, such as indicating a specific CA or service
being used. To mitigate this risk, servers SHOULD deliver such information
in-band when possible, such as through the use of OCSP stapling, and clients
SHOULD take steps to minimize or protect such requests during certificate
validation.<a href="#section-10.7-2" class="pilcrow">¶</a></p>
<p id="section-10.7-3">Attacks that rely on non-ECH traffic to infer server identity in an ECH
connection are out of scope for this document. For example, a client that
connects to a particular host prior to ECH deployment may later resume a
connection to that same host after ECH deployment. An adversary that observes
this can deduce that the ECH-enabled connection was made to a host that the
client previously connected to and which is within the same anonymity set.<a href="#section-10.7-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="cookies">
<section id="section-10.8">
        <h3 id="name-cookies">
<a href="#section-10.8" class="section-number selfRef">10.8. </a><a href="#name-cookies" class="section-name selfRef">Cookies</a>
        </h3>
<p id="section-10.8-1"><span><a href="https://rfc-editor.org/rfc/rfc8446#section-4.2.2" class="relref">Section 4.2.2</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span> defines a cookie value that servers may send in
HelloRetryRequest for clients to echo in the second ClientHello. While ECH
encrypts the cookie in the second ClientHelloInner, the backend server's
HelloRetryRequest is unencrypted.This means differences in cookies between
backend servers, such as lengths or cleartext components, may leak information
about the server identity.<a href="#section-10.8-1" class="pilcrow">¶</a></p>
<p id="section-10.8-2">Backend servers in an anonymity set SHOULD NOT reveal information in the cookie
which identifies the server. This may be done by handling HelloRetryRequest
statefully, thus not sending cookies, or by using the same cookie construction
for all backend servers.<a href="#section-10.8-2" class="pilcrow">¶</a></p>
<p id="section-10.8-3">Note that, if the cookie includes a key name, analogous to Section 4 of
<span>[<a href="#RFC5077" class="cite xref">RFC5077</a>]</span>, this may leak information if different backend servers issue
cookies with different key names at the time of the connection. In particular,
if the deployment operates in Split Mode, the backend servers may not share
cookie encryption keys. Backend servers may mitigate this by either handling
key rotation with trial decryption, or coordinating to match key names.<a href="#section-10.8-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="attacks-exploiting-acceptance-confirmation">
<section id="section-10.9">
        <h3 id="name-attacks-exploiting-acceptan">
<a href="#section-10.9" class="section-number selfRef">10.9. </a><a href="#name-attacks-exploiting-acceptan" class="section-name selfRef">Attacks Exploiting Acceptance Confirmation</a>
        </h3>
<p id="section-10.9-1">To signal acceptance, the backend server overwrites 8 bytes of its
ServerHello.random with a value derived from the ClientHelloInner.random. (See
<a href="#backend-server" class="auto internal xref">Section 7.2</a> for details.) This behavior increases the likelihood of the
ServerHello.random colliding with the ServerHello.random of a previous session,
potentially reducing the overall security of the protocol. However, the
remaining 24 bytes provide enough entropy to ensure this is not a practical
avenue of attack.<a href="#section-10.9-1" class="pilcrow">¶</a></p>
<p id="section-10.9-2">On the other hand, the probability that two 8-byte strings are the same is
non-negligible. This poses a modest operational risk. Suppose the client-facing
server terminates the connection (i.e., ECH is rejected or bypassed): if the
last 8 bytes of its ServerHello.random coincide with the confirmation signal,
then the client will incorrectly presume acceptance and proceed as if the
backend server terminated the connection. However, the probability of a false
positive occurring for a given connection is only 1 in 2^64. This value is
smaller than the probability of network connection failures in practice.<a href="#section-10.9-2" class="pilcrow">¶</a></p>
<p id="section-10.9-3">Note that the same bytes of the ServerHello.random are used to implement
downgrade protection for TLS 1.3 (see <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-4.1.3" class="relref">Section 4.1.3</a></span>). These
mechanisms do not interfere because the backend server only signals ECH
acceptance in TLS 1.3 or higher.<a href="#section-10.9-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="comparison-against-criteria">
<section id="section-10.10">
        <h3 id="name-comparison-against-criteria">
<a href="#section-10.10" class="section-number selfRef">10.10. </a><a href="#name-comparison-against-criteria" class="section-name selfRef">Comparison Against Criteria</a>
        </h3>
<p id="section-10.10-1"><span>[<a href="#RFC8744" class="cite xref">RFC8744</a>]</span> lists several requirements for SNI encryption.
In this section, we re-iterate these requirements and assess the ECH design
against them.<a href="#section-10.10-1" class="pilcrow">¶</a></p>
<div id="mitigate-cut-and-paste-attacks">
<section id="section-10.10.1">
          <h4 id="name-mitigate-cut-and-paste-atta">
<a href="#section-10.10.1" class="section-number selfRef">10.10.1. </a><a href="#name-mitigate-cut-and-paste-atta" class="section-name selfRef">Mitigate Cut-and-Paste Attacks</a>
          </h4>
<p id="section-10.10.1-1">Since servers process either ClientHelloInner or ClientHelloOuter, and because
ClientHelloInner.random is encrypted, it is not possible for an attacker to "cut
and paste" the ECH value in a different Client Hello and learn information from
ClientHelloInner.<a href="#section-10.10.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="avoid-widely-shared-secrets">
<section id="section-10.10.2">
          <h4 id="name-avoid-widely-shared-secrets">
<a href="#section-10.10.2" class="section-number selfRef">10.10.2. </a><a href="#name-avoid-widely-shared-secrets" class="section-name selfRef">Avoid Widely Shared Secrets</a>
          </h4>
<p id="section-10.10.2-1">This design depends upon DNS as a vehicle for semi-static public key
distribution. Server operators may partition their private keys however they
see fit provided each server behind an IP address has the corresponding private
key to decrypt a key. Thus, when one ECH key is provided, sharing is optimally
bound by the number of hosts that share an IP address. Server operators may
further limit sharing by publishing different DNS records containing ECHConfig
values with different keys using a short TTL.<a href="#section-10.10.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sni-based-denial-of-service-attacks">
<section id="section-10.10.3">
          <h4 id="name-sni-based-denial-of-service">
<a href="#section-10.10.3" class="section-number selfRef">10.10.3. </a><a href="#name-sni-based-denial-of-service" class="section-name selfRef">SNI-Based Denial-of-Service Attacks</a>
          </h4>
<p id="section-10.10.3-1">This design requires servers to decrypt ClientHello messages with ECHClientHello
extensions carrying valid digests. Thus, it is possible for an attacker to force
decryption operations on the server. This attack is bound by the number of valid
transport connections an attacker can open.<a href="#section-10.10.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="dont-stick-out">
<section id="section-10.10.4">
          <h4 id="name-do-not-stick-out">
<a href="#section-10.10.4" class="section-number selfRef">10.10.4. </a><a href="#name-do-not-stick-out" class="section-name selfRef">Do Not Stick Out</a>
          </h4>
<p id="section-10.10.4-1">As a means of reducing the impact of network ossification, <span>[<a href="#RFC8744" class="cite xref">RFC8744</a>]</span>
recommends SNI-protection mechanisms be designed in such a way that network
operators do not differentiate connections using the mechanism from connections
not using the mechanism. To that end, ECH is designed to resemble a standard
TLS handshake as much as possible. The most obvious difference is the extension
itself: as long as middleboxes ignore it, as required by <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>, the rest
of the handshake is designed to look very much as usual.<a href="#section-10.10.4-1" class="pilcrow">¶</a></p>
<p id="section-10.10.4-2">The GREASE ECH protocol described in <a href="#grease-ech" class="auto internal xref">Section 6.2</a> provides a low-risk way to
evaluate the deployability of ECH. It is designed to mimic the real ECH protocol
(<a href="#real-ech" class="auto internal xref">Section 6.1</a>) without changing the security properties of the handshake. The
underlying theory is that if GREASE ECH is deployable without triggering
middlebox misbehavior, and real ECH looks enough like GREASE ECH, then ECH
should be deployable as well. Thus, the strategy for mitigating network
ossification is to deploy GREASE ECH widely enough to disincentivize
differential treatment of the real ECH protocol by the network.<a href="#section-10.10.4-2" class="pilcrow">¶</a></p>
<p id="section-10.10.4-3">Ensuring that networks do not differentiate between real ECH and GREASE ECH may
not be feasible for all implementations. While most middleboxes will not treat
them differently, some operators may wish to block real ECH usage but allow
GREASE ECH. This specification aims to provide a baseline security level that
most deployments can achieve easily, while providing implementations enough
flexibility to achieve stronger security where possible. Minimally, real ECH is
designed to be indifferentiable from GREASE ECH for passive adversaries with
following capabilities:<a href="#section-10.10.4-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-10.10.4-4">
<li id="section-10.10.4-4.1">
              <p id="section-10.10.4-4.1.1">The attacker does not know the ECHConfigList used by the server.<a href="#section-10.10.4-4.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-10.10.4-4.2">
              <p id="section-10.10.4-4.2.1">The attacker keeps per-connection state only. In particular, it does not
track endpoints across connections.<a href="#section-10.10.4-4.2.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-10.10.4-5">Moreover, real ECH and GREASE ECH are designed so that the following features
do not noticeably vary to the attacker, i.e., they are not distinguishers:<a href="#section-10.10.4-5" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-10.10.4-6">
<li id="section-10.10.4-6.1">
              <p id="section-10.10.4-6.1.1">the code points of extensions negotiated in the clear, and their order;<a href="#section-10.10.4-6.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-10.10.4-6.2">
              <p id="section-10.10.4-6.2.1">the length of messages; and<a href="#section-10.10.4-6.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-10.10.4-6.3">
              <p id="section-10.10.4-6.3.1">the values of plaintext alert messages.<a href="#section-10.10.4-6.3.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-10.10.4-7">This leaves a variety of practical differentiators out-of-scope. including,
though not limited to, the following:<a href="#section-10.10.4-7" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-10.10.4-8">
<li id="section-10.10.4-8.1">
              <p id="section-10.10.4-8.1.1">the value of the configuration identifier;<a href="#section-10.10.4-8.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-10.10.4-8.2">
              <p id="section-10.10.4-8.2.1">the value of the outer SNI;<a href="#section-10.10.4-8.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-10.10.4-8.3">
              <p id="section-10.10.4-8.3.1">the TLS version negotiated, which may depend on ECH acceptance;<a href="#section-10.10.4-8.3.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-10.10.4-8.4">
              <p id="section-10.10.4-8.4.1">client authentication, which may depend on ECH acceptance; and<a href="#section-10.10.4-8.4.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-10.10.4-8.5">
              <p id="section-10.10.4-8.5.1">HRR issuance, which may depend on ECH acceptance.<a href="#section-10.10.4-8.5.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-10.10.4-9">These can be addressed with more sophisticated implementations, but some
mitigations require coordination between the client and server, and even
across different client and server implementations. These mitigations are
out-of-scope for this specification.<a href="#section-10.10.4-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="maintain-forward-secrecy">
<section id="section-10.10.5">
          <h4 id="name-maintain-forward-secrecy">
<a href="#section-10.10.5" class="section-number selfRef">10.10.5. </a><a href="#name-maintain-forward-secrecy" class="section-name selfRef">Maintain Forward Secrecy</a>
          </h4>
<p id="section-10.10.5-1">This design does not provide forward secrecy for the inner ClientHello
because the server's ECH key is static.  However, the window of
exposure is bound by the key lifetime. It is RECOMMENDED that servers
rotate keys regularly.<a href="#section-10.10.5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="enable-multi-party-security-contexts">
<section id="section-10.10.6">
          <h4 id="name-enable-multi-party-security">
<a href="#section-10.10.6" class="section-number selfRef">10.10.6. </a><a href="#name-enable-multi-party-security" class="section-name selfRef">Enable Multi-party Security Contexts</a>
          </h4>
<p id="section-10.10.6-1">This design permits servers operating in Split Mode to forward connections
directly to backend origin servers. The client authenticates the identity of
the backend origin server, thereby allowing the backend origin server
to hide behind the client-facing server without the client-facing
server decrypting and reencrypting the connection.<a href="#section-10.10.6-1" class="pilcrow">¶</a></p>
<p id="section-10.10.6-2">Conversely, assuming ECH records retrieved from DNS are authenticated, e.g.,
via DNSSEC or fetched from a trusted Recursive Resolver, spoofing a
client-facing server operating in Split Mode is not possible. See
<a href="#plaintext-dns" class="auto internal xref">Section 10.2</a> for more details regarding plaintext DNS.<a href="#section-10.10.6-2" class="pilcrow">¶</a></p>
<p id="section-10.10.6-3">Authenticating the ECHConfig structure naturally authenticates the included
public name. This also authenticates any retry signals from the client-facing
server because the client validates the server certificate against the public
name before retrying.<a href="#section-10.10.6-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="support-multiple-protocols">
<section id="section-10.10.7">
          <h4 id="name-support-multiple-protocols">
<a href="#section-10.10.7" class="section-number selfRef">10.10.7. </a><a href="#name-support-multiple-protocols" class="section-name selfRef">Support Multiple Protocols</a>
          </h4>
<p id="section-10.10.7-1">This design has no impact on application layer protocol negotiation. It may
affect connection routing, server certificate selection, and client certificate
verification. Thus, it is compatible with multiple application and transport
protocols. By encrypting the entire ClientHello, this design additionally
supports encrypting the ALPN extension.<a href="#section-10.10.7-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="padding-policy">
<section id="section-10.11">
        <h3 id="name-padding-policy">
<a href="#section-10.11" class="section-number selfRef">10.11. </a><a href="#name-padding-policy" class="section-name selfRef">Padding Policy</a>
        </h3>
<p id="section-10.11-1">Variations in the length of the ClientHelloInner ciphertext could leak
information about the corresponding plaintext. <a href="#padding" class="auto internal xref">Section 6.1.3</a> describes a
RECOMMENDED padding mechanism for clients aimed at reducing potential
information leakage.<a href="#section-10.11-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="active-attack-mitigations">
<section id="section-10.12">
        <h3 id="name-active-attack-mitigations">
<a href="#section-10.12" class="section-number selfRef">10.12. </a><a href="#name-active-attack-mitigations" class="section-name selfRef">Active Attack Mitigations</a>
        </h3>
<p id="section-10.12-1">This section describes the rationale for ECH properties and mechanics as
defenses against active attacks. In all the attacks below, the attacker is
on-path between the target client and server. The goal of the attacker is to
learn private information about the inner ClientHello, such as the true SNI
value.<a href="#section-10.12-1" class="pilcrow">¶</a></p>
<div id="flow-client-reaction">
<section id="section-10.12.1">
          <h4 id="name-client-reaction-attack-miti">
<a href="#section-10.12.1" class="section-number selfRef">10.12.1. </a><a href="#name-client-reaction-attack-miti" class="section-name selfRef">Client Reaction Attack Mitigation</a>
          </h4>
<p id="section-10.12.1-1">This attack uses the client's reaction to an incorrect certificate as an oracle.
The attacker intercepts a legitimate ClientHello and replies with a ServerHello,
Certificate, CertificateVerify, and Finished messages, wherein the Certificate
message contains a "test" certificate for the domain name it wishes to query. If
the client decrypted the Certificate and failed verification (or leaked
information about its verification process by a timing side channel), the
attacker learns that its test certificate name was incorrect. As an example,
suppose the client's SNI value in its inner ClientHello is "example.com," and
the attacker replied with a Certificate for "test.com". If the client produces a
verification failure alert because of the mismatch faster than it would due to
the Certificate signature validation, information about the name leaks. Note
that the attacker can also withhold the CertificateVerify message. In that
scenario, a client which first verifies the Certificate would then respond
similarly and leak the same information.<a href="#section-10.12.1-1" class="pilcrow">¶</a></p>
<span id="name-client-reaction-attack"></span><div id="flow-diagram-client-reaction">
<figure id="figure-3">
            <div class="alignLeft art-text artwork" id="section-10.12.1-2.1">
<pre>
 Client                         Attacker               Server
   ClientHello
   + key_share
   + ech         ------&gt;      (intercept)     -----&gt; X (drop)

                             ServerHello
                             + key_share
                   {EncryptedExtensions}
                   {CertificateRequest*}
                          {Certificate*}
                    {CertificateVerify*}
                 &lt;------
   Alert
                 ------&gt;
</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-client-reaction-attack" class="selfRef">Client reaction attack</a>
            </figcaption></figure>
</div>
<p id="section-10.12.1-3">ClientHelloInner.random prevents this attack. In particular, since the attacker
does not have access to this value, it cannot produce the right transcript and
handshake keys needed for encrypting the Certificate message. Thus, the client
will fail to decrypt the Certificate and abort the connection.<a href="#section-10.12.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="flow-hrr-hijack">
<section id="section-10.12.2">
          <h4 id="name-helloretryrequest-hijack-mi">
<a href="#section-10.12.2" class="section-number selfRef">10.12.2. </a><a href="#name-helloretryrequest-hijack-mi" class="section-name selfRef">HelloRetryRequest Hijack Mitigation</a>
          </h4>
<p id="section-10.12.2-1">This attack aims to exploit server HRR state management to recover information
about a legitimate ClientHello using its own attacker-controlled ClientHello.
To begin, the attacker intercepts and forwards a legitimate ClientHello with an
"encrypted_client_hello" (ech) extension to the server, which triggers a
legitimate HelloRetryRequest in return. Rather than forward the retry to the
client, the attacker attempts to generate its own ClientHello in response based
on the contents of the first ClientHello and HelloRetryRequest exchange with the
result that the server encrypts the Certificate to the attacker. If the server
used the SNI from the first ClientHello and the key share from the second
(attacker-controlled) ClientHello, the Certificate produced would leak the
client's chosen SNI to the attacker.<a href="#section-10.12.2-1" class="pilcrow">¶</a></p>
<span id="name-helloretryrequest-hijack-at"></span><div id="flow-diagram-hrr-hijack">
<figure id="figure-4">
            <div class="alignLeft art-text artwork" id="section-10.12.2-2.1">
<pre>
 Client                         Attacker                   Server
   ClientHello
   + key_share
   + ech         ------&gt;       (forward)        -------&gt;
                                              HelloRetryRequest
                                                    + key_share
                              (intercept)       &lt;-------

                              ClientHello
                              + key_share'
                              + ech'           -------&gt;
                                                    ServerHello
                                                    + key_share
                                          {EncryptedExtensions}
                                          {CertificateRequest*}
                                                 {Certificate*}
                                           {CertificateVerify*}
                                                     {Finished}
                                                &lt;-------
                         (process server flight)
</pre>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-helloretryrequest-hijack-at" class="selfRef">HelloRetryRequest hijack attack</a>
            </figcaption></figure>
</div>
<p id="section-10.12.2-3">This attack is mitigated by using the same HPKE context for both ClientHello
messages. The attacker does not possess the context's keys, so it cannot
generate a valid encryption of the second inner ClientHello.<a href="#section-10.12.2-3" class="pilcrow">¶</a></p>
<p id="section-10.12.2-4">If the attacker could manipulate the second ClientHello, it might be possible
for the server to act as an oracle if it required parameters from the first
ClientHello to match that of the second ClientHello. For example, imagine the
client's original SNI value in the inner ClientHello is "example.com", and the
attacker's hijacked SNI value in its inner ClientHello is "test.com". A server
which checks these for equality and changes behavior based on the result can be
used as an oracle to learn the client's SNI.<a href="#section-10.12.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="flow-clienthello-malleability">
<section id="section-10.12.3">
          <h4 id="name-clienthello-malleability-mi">
<a href="#section-10.12.3" class="section-number selfRef">10.12.3. </a><a href="#name-clienthello-malleability-mi" class="section-name selfRef">ClientHello Malleability Mitigation</a>
          </h4>
<p id="section-10.12.3-1">This attack aims to leak information about secret parts of the encrypted
ClientHello by adding attacker-controlled parameters and observing the server's
response. In particular, the compression mechanism described in
<a href="#encoding-inner" class="auto internal xref">Section 5.1</a> references parts of a potentially attacker-controlled
ClientHelloOuter to construct ClientHelloInner, or a buggy server may
incorrectly apply parameters from ClientHelloOuter to the handshake.<a href="#section-10.12.3-1" class="pilcrow">¶</a></p>
<p id="section-10.12.3-2">To begin, the attacker first interacts with a server to obtain a resumption
ticket for a given test domain, such as "example.com". Later, upon receipt of a
ClientHelloOuter, it modifies it such that the server will process the
resumption ticket with ClientHelloInner. If the server only accepts resumption
PSKs that match the server name, it will fail the PSK binder check with an
alert when ClientHelloInner is for "example.com" but silently ignore the PSK
and continue when ClientHelloInner is for any other name. This introduces an
oracle for testing encrypted SNI values.<a href="#section-10.12.3-2" class="pilcrow">¶</a></p>
<span id="name-message-flow-for-malleable-"></span><div id="tls-clienthello-malleability">
<figure id="figure-5">
            <div class="alignLeft art-text artwork" id="section-10.12.3-3.1">
<pre>
      Client              Attacker                       Server

                                    handshake and ticket
                                       for "example.com"
                                       &lt;--------&gt;

      ClientHello
      + key_share
      + ech
         + ech_outer_extensions(pre_shared_key)
      + pre_shared_key
                  --------&gt;
                        (intercept)
                        ClientHello
                        + key_share
                        + ech
                           + ech_outer_extensions(pre_shared_key)
                        + pre_shared_key'
                                          --------&gt;
                                                         Alert
                                                         -or-
                                                   ServerHello
                                                            ...
                                                      Finished
                                          &lt;--------
</pre>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-message-flow-for-malleable-" class="selfRef">Message flow for malleable ClientHello</a>
            </figcaption></figure>
</div>
<p id="section-10.12.3-4">This attack may be generalized to any parameter which the server varies by
server name, such as ALPN preferences.<a href="#section-10.12.3-4" class="pilcrow">¶</a></p>
<p id="section-10.12.3-5">ECH mitigates this attack by only negotiating TLS parameters from
ClientHelloInner and authenticating all inputs to the ClientHelloInner
(EncodedClientHelloInner and ClientHelloOuter) with the HPKE AEAD. See
<a href="#authenticating-outer" class="auto internal xref">Section 5.2</a>. The decompression process in <a href="#encoding-inner" class="auto internal xref">Section 5.1</a>
forbids "encrypted_client_hello" in OuterExtensions. This ensures the
unauthenticated portion of ClientHelloOuter is not incorporated into
ClientHelloInner.
An earlier iteration of this specification only
encrypted and authenticated the "server_name" extension, which left the overall
ClientHello vulnerable to an analogue of this attack.<a href="#section-10.12.3-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="decompression-amp">
<section id="section-10.12.4">
          <h4 id="name-clienthelloinner-packet-amp">
<a href="#section-10.12.4" class="section-number selfRef">10.12.4. </a><a href="#name-clienthelloinner-packet-amp" class="section-name selfRef">ClientHelloInner Packet Amplification Mitigation</a>
          </h4>
<p id="section-10.12.4-1">Client-facing servers must decompress EncodedClientHelloInners. A malicious
attacker may craft a packet which takes excessive resources to decompress
or may be much larger than the incoming packet:<a href="#section-10.12.4-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.12.4-2.1">
              <p id="section-10.12.4-2.1.1">If looking up a ClientHelloOuter extension takes time linear in the number of
extensions, the overall decoding process would take O(M*N) time, where
M is the number of extensions in ClientHelloOuter and N is the
size of OuterExtensions.<a href="#section-10.12.4-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-10.12.4-2.2">
              <p id="section-10.12.4-2.2.1">If the same ClientHelloOuter extension can be copied multiple times,
an attacker could cause the client-facing server to construct a large
ClientHelloInner by including a large extension in ClientHelloOuter,
of length L, and an OuterExtensions list referencing N copies of that
extension. The client-facing server would then use O(N*L) memory in
response to O(N+L) bandwidth from the client. In split-mode, an
O(N*L) sized packet would then be transmitted to the
backend server.<a href="#section-10.12.4-2.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-10.12.4-3">ECH mitigates this attack by requiring that OuterExtensions be referenced in
order, that duplicate references be rejected, and by recommending that
client-facing servers use a linear scan to perform decompression. These
requirements are detailed in <a href="#encoding-inner" class="auto internal xref">Section 5.1</a>.<a href="#section-10.12.4-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-11">
      <h2 id="name-iana-considerations">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<div id="update-of-the-tls-extensiontype-registry">
<section id="section-11.1">
        <h3 id="name-update-of-the-tls-extension">
<a href="#section-11.1" class="section-number selfRef">11.1. </a><a href="#name-update-of-the-tls-extension" class="section-name selfRef">Update of the TLS ExtensionType Registry</a>
        </h3>
<p id="section-11.1-1">IANA is requested to create the following entries in the existing registry for
ExtensionType (defined in <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>):<a href="#section-11.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-11.1-2">
<li id="section-11.1-2.1">
            <p id="section-11.1-2.1.1">encrypted_client_hello(0xfe0d), with "TLS 1.3" column values set to
"CH, HRR, EE", "DTLS-Only" column set to "N", and "Recommended" column set
to "Yes".<a href="#section-11.1-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-11.1-2.2">
            <p id="section-11.1-2.2.1">ech_outer_extensions(0xfd00), with the "TLS 1.3" column values set to "CH",
"DTLS-Only" column set to "N", "Recommended" column set to "Yes", and the
"Comment" column set to "Only appears in inner CH."<a href="#section-11.1-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
</section>
</div>
<div id="alerts">
<section id="section-11.2">
        <h3 id="name-update-of-the-tls-alert-reg">
<a href="#section-11.2" class="section-number selfRef">11.2. </a><a href="#name-update-of-the-tls-alert-reg" class="section-name selfRef">Update of the TLS Alert Registry</a>
        </h3>
<p id="section-11.2-1">IANA is requested to create an entry, ech_required(121) in the existing registry
for Alerts (defined in <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>), with the "DTLS-OK" column set to
"Y".<a href="#section-11.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="config-extensions-iana">
<section id="section-11.3">
        <h3 id="name-ech-configuration-extension">
<a href="#section-11.3" class="section-number selfRef">11.3. </a><a href="#name-ech-configuration-extension" class="section-name selfRef">ECH Configuration Extension Registry</a>
        </h3>
<p id="section-11.3-1">IANA is requested to create a new "ECHConfig Extension" registry in a new
"TLS Encrypted Client Hello (ECH) Configuration Extensions" page. New
registrations need to list the following attributes:<a href="#section-11.3-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlCompact dlParallel" id="section-11.3-2">
          <dt id="section-11.3-2.1">Value:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-2.2">
            <p id="section-11.3-2.2.1">The two-byte identifier for the ECHConfigExtension, i.e., the
ECHConfigExtensionType<a href="#section-11.3-2.2.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-11.3-2.3">Extension Name:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-2.4">
            <p id="section-11.3-2.4.1">Name of the ECHConfigExtension<a href="#section-11.3-2.4.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-11.3-2.5">Recommended:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-2.6">
            <p id="section-11.3-2.6.1">A "Y" or "N" value indicating if the extension is TLS WG recommends that the
extension be supported. This column is assigned a value of "N" unless
explicitly requested. Adding a value with a value of "Y" requires Standards
Action <span>[<a href="#RFC8126" class="cite xref">RFC8126</a>]</span>.<a href="#section-11.3-2.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-11.3-2.7">Reference:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-2.8">
            <p id="section-11.3-2.8.1">The specification where the ECHConfigExtension is defined<a href="#section-11.3-2.8.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-11.3-2.9">Notes:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-2.10">
            <p id="section-11.3-2.10.1">Any notes associated with the entry<a href="#section-11.3-2.10.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
</dl>
<p id="section-11.3-3">New entries in the "ECHConfig Extension" registry are subject to the
Specification Required registration policy (<span>[<a href="#RFC8126" class="cite xref">RFC8126</a>], <a href="https://rfc-editor.org/rfc/rfc8126#section-4.6" class="relref">Section 4.6</a></span>), with the policies described in <span>[<a href="#RFC8447" class="cite xref">RFC8447</a>], <a href="https://rfc-editor.org/rfc/rfc8447#section-17" class="relref">Section 17</a></span>. IANA
[shall add/has added] the following note to the TLS ECHConfig Extension
registry:<a href="#section-11.3-3" class="pilcrow">¶</a></p>
<p id="section-11.3-4">Note:  The role of the designated expert is described in RFC 8447.
      The designated expert <span>[<a href="#RFC8126" class="cite xref">RFC8126</a>]</span> ensures that the specification is
      publicly available.  It is sufficient to have an Internet-Draft
      (that is posted and never published as an RFC) or a document from
      another standards body, industry consortium, university site, etc.
      The expert may provide more in depth reviews, but their approval
      should not be taken as an endorsement of the extension.<a href="#section-11.3-4" class="pilcrow">¶</a></p>
<p id="section-11.3-5">This document defines several Reserved values for ECH configuration extensions.
These can be used by servers to "grease" the contents of the
ECH configuration, as inspired by <span>[<a href="#RFC8701" class="cite xref">RFC8701</a>]</span>. This helps ensure clients
process ECH extensions correctly. When constructing ECH configurations,
servers SHOULD randomly select from reserved values with the high-order
bit clear. Correctly-implemented client will ignore those extensions.<a href="#section-11.3-5" class="pilcrow">¶</a></p>
<p id="section-11.3-6">The reserved values with the high-order bit set are mandatory, as defined
in <a href="#config-extensions" class="auto internal xref">Section 4.2</a>. Servers SHOULD randomly select from these
values and include them in extraneous ECH configurations. These
extraneous ECH configurations SHOULD have invalid keys, and public
names which the server does not respond to. Correctly-implemented
clients will ignore these configurations.<a href="#section-11.3-6" class="pilcrow">¶</a></p>
<p id="section-11.3-7">The initial contents for this registry consists of multiple reserved values,
with the following attributes, which are repeated for each registration:<a href="#section-11.3-7" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlCompact dlParallel" id="section-11.3-8">
          <dt id="section-11.3-8.1">Value:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-8.2">
            <p id="section-11.3-8.2.1">0x0000, 0x1A1A, 0x2A2A, 0x3A3A, 0x4A4A, 0x5A5A, 0x6A6A, 0x7A7A, 0x8A8A,
0x9A9A, 0xAAAA, 0xBABA, 0xCACA, 0xDADA, 0xEAEA, 0xFAFA<a href="#section-11.3-8.2.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-11.3-8.3">Extension Name:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-8.4">
            <p id="section-11.3-8.4.1">RESERVED<a href="#section-11.3-8.4.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-11.3-8.5">Recommended:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-8.6">
            <p id="section-11.3-8.6.1">Y<a href="#section-11.3-8.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-11.3-8.7">Reference:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-8.8">
            <p id="section-11.3-8.8.1">This document<a href="#section-11.3-8.8.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-11.3-8.9">Notes:</dt>
          <dd style="margin-left: 1.5em" id="section-11.3-8.10">
            <p id="section-11.3-8.10.1">Grease entries.<a href="#section-11.3-8.10.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="sec-combined-references">
<section id="section-12">
      <h2 id="name-references">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<div id="sec-normative-references">
<section id="section-12.1">
        <h3 id="name-normative-references">
<a href="#section-12.1" class="section-number selfRef">12.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="ECH-IN-DNS">[ECH-IN-DNS]</dt>
        <dd>
<span class="refAuthor">Schwartz, B. M.</span>, <span class="refAuthor">Bishop, M.</span>, and <span class="refAuthor">E. Nygren</span>, <span class="refTitle">"Bootstrapping TLS Encrypted ClientHello with DNS Service Bindings"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-tls-svcb-ech-07</span>, <time datetime="2025-02-12" class="refDate">12 February 2025</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-tls-svcb-ech-07">https://datatracker.ietf.org/doc/html/draft-ietf-tls-svcb-ech-07</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="HPKE">[HPKE]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Bhargavan, K.</span>, <span class="refAuthor">Lipp, B.</span>, and <span class="refAuthor">C. Wood</span>, <span class="refTitle">"Hybrid Public Key Encryption"</span>, <span class="seriesInfo">RFC 9180</span>, <span class="seriesInfo">DOI 10.17487/RFC9180</span>, <time datetime="2022-02" class="refDate">February 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9180">https://www.rfc-editor.org/rfc/rfc9180</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5890">[RFC5890]</dt>
        <dd>
<span class="refAuthor">Klensin, J.</span>, <span class="refTitle">"Internationalized Domain Names for Applications (IDNA): Definitions and Document Framework"</span>, <span class="seriesInfo">RFC 5890</span>, <span class="seriesInfo">DOI 10.17487/RFC5890</span>, <time datetime="2010-08" class="refDate">August 2010</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5890">https://www.rfc-editor.org/rfc/rfc5890</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7918">[RFC7918]</dt>
        <dd>
<span class="refAuthor">Langley, A.</span>, <span class="refAuthor">Modadugu, N.</span>, and <span class="refAuthor">B. Moeller</span>, <span class="refTitle">"Transport Layer Security (TLS) False Start"</span>, <span class="seriesInfo">RFC 7918</span>, <span class="seriesInfo">DOI 10.17487/RFC7918</span>, <time datetime="2016-08" class="refDate">August 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7918">https://www.rfc-editor.org/rfc/rfc7918</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8126">[RFC8126]</dt>
        <dd>
<span class="refAuthor">Cotton, M.</span>, <span class="refAuthor">Leiba, B.</span>, and <span class="refAuthor">T. Narten</span>, <span class="refTitle">"Guidelines for Writing an IANA Considerations Section in RFCs"</span>, <span class="seriesInfo">BCP 26</span>, <span class="seriesInfo">RFC 8126</span>, <span class="seriesInfo">DOI 10.17487/RFC8126</span>, <time datetime="2017-06" class="refDate">June 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8126">https://www.rfc-editor.org/rfc/rfc8126</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8447">[RFC8447]</dt>
        <dd>
<span class="refAuthor">Salowey, J.</span> and <span class="refAuthor">S. Turner</span>, <span class="refTitle">"IANA Registry Updates for TLS and DTLS"</span>, <span class="seriesInfo">RFC 8447</span>, <span class="seriesInfo">DOI 10.17487/RFC8447</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8447">https://www.rfc-editor.org/rfc/rfc8447</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9147">[RFC9147]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refAuthor">Tschofenig, H.</span>, and <span class="refAuthor">N. Modadugu</span>, <span class="refTitle">"The Datagram Transport Layer Security (DTLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 9147</span>, <span class="seriesInfo">DOI 10.17487/RFC9147</span>, <time datetime="2022-04" class="refDate">April 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9147">https://www.rfc-editor.org/rfc/rfc9147</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9460">[RFC9460]</dt>
      <dd>
<span class="refAuthor">Schwartz, B.</span>, <span class="refAuthor">Bishop, M.</span>, and <span class="refAuthor">E. Nygren</span>, <span class="refTitle">"Service Binding and Parameter Specification via the DNS (SVCB and HTTPS Resource Records)"</span>, <span class="seriesInfo">RFC 9460</span>, <span class="seriesInfo">DOI 10.17487/RFC9460</span>, <time datetime="2023-11" class="refDate">November 2023</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9460">https://www.rfc-editor.org/rfc/rfc9460</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="sec-informative-references">
<section id="section-12.2">
        <h3 id="name-informative-references">
<a href="#section-12.2" class="section-number selfRef">12.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="DNS-TERMS">[DNS-TERMS]</dt>
        <dd>
<span class="refAuthor">Hoffman, P.</span>, <span class="refAuthor">Sullivan, A.</span>, and <span class="refAuthor">K. Fujiwara</span>, <span class="refTitle">"DNS Terminology"</span>, <span class="seriesInfo">RFC 8499</span>, <span class="seriesInfo">DOI 10.17487/RFC8499</span>, <time datetime="2019-01" class="refDate">January 2019</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8499">https://www.rfc-editor.org/rfc/rfc8499</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="ECH-Analysis">[ECH-Analysis]</dt>
        <dd>
<span class="refTitle">"A Symbolic Analysis of Privacy for TLS 1.3 with Encrypted Client Hello"</span>, <time datetime="2022-11" class="refDate">November 2022</time>, <span>&lt;<a href="https://www.cs.ox.ac.uk/people/vincent.cheval/publis/BCW-ccs22.pdf">https://www.cs.ox.ac.uk/people/vincent.cheval/publis/BCW-ccs22.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.kazuho-protected-sni">[I-D.kazuho-protected-sni]</dt>
        <dd>
<span class="refAuthor">Oku, K.</span>, <span class="refTitle">"TLS Extensions for Protecting SNI"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-kazuho-protected-sni-00</span>, <time datetime="2017-07-18" class="refDate">18 July 2017</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-kazuho-protected-sni-00">https://datatracker.ietf.org/doc/html/draft-kazuho-protected-sni-00</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3986">[RFC3986]</dt>
        <dd>
<span class="refAuthor">Berners-Lee, T.</span>, <span class="refAuthor">Fielding, R.</span>, and <span class="refAuthor">L. Masinter</span>, <span class="refTitle">"Uniform Resource Identifier (URI): Generic Syntax"</span>, <span class="seriesInfo">STD 66</span>, <span class="seriesInfo">RFC 3986</span>, <span class="seriesInfo">DOI 10.17487/RFC3986</span>, <time datetime="2005-01" class="refDate">January 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc3986">https://www.rfc-editor.org/rfc/rfc3986</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5077">[RFC5077]</dt>
        <dd>
<span class="refAuthor">Salowey, J.</span>, <span class="refAuthor">Zhou, H.</span>, <span class="refAuthor">Eronen, P.</span>, and <span class="refAuthor">H. Tschofenig</span>, <span class="refTitle">"Transport Layer Security (TLS) Session Resumption without Server-Side State"</span>, <span class="seriesInfo">RFC 5077</span>, <span class="seriesInfo">DOI 10.17487/RFC5077</span>, <time datetime="2008-01" class="refDate">January 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5077">https://www.rfc-editor.org/rfc/rfc5077</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7301">[RFC7301]</dt>
        <dd>
<span class="refAuthor">Friedl, S.</span>, <span class="refAuthor">Popov, A.</span>, <span class="refAuthor">Langley, A.</span>, and <span class="refAuthor">E. Stephan</span>, <span class="refTitle">"Transport Layer Security (TLS) Application-Layer Protocol Negotiation Extension"</span>, <span class="seriesInfo">RFC 7301</span>, <span class="seriesInfo">DOI 10.17487/RFC7301</span>, <time datetime="2014-07" class="refDate">July 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7301">https://www.rfc-editor.org/rfc/rfc7301</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7858">[RFC7858]</dt>
        <dd>
<span class="refAuthor">Hu, Z.</span>, <span class="refAuthor">Zhu, L.</span>, <span class="refAuthor">Heidemann, J.</span>, <span class="refAuthor">Mankin, A.</span>, <span class="refAuthor">Wessels, D.</span>, and <span class="refAuthor">P. Hoffman</span>, <span class="refTitle">"Specification for DNS over Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 7858</span>, <span class="seriesInfo">DOI 10.17487/RFC7858</span>, <time datetime="2016-05" class="refDate">May 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7858">https://www.rfc-editor.org/rfc/rfc7858</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7924">[RFC7924]</dt>
        <dd>
<span class="refAuthor">Santesson, S.</span> and <span class="refAuthor">H. Tschofenig</span>, <span class="refTitle">"Transport Layer Security (TLS) Cached Information Extension"</span>, <span class="seriesInfo">RFC 7924</span>, <span class="seriesInfo">DOI 10.17487/RFC7924</span>, <time datetime="2016-07" class="refDate">July 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7924">https://www.rfc-editor.org/rfc/rfc7924</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8094">[RFC8094]</dt>
        <dd>
<span class="refAuthor">Reddy, T.</span>, <span class="refAuthor">Wing, D.</span>, and <span class="refAuthor">P. Patil</span>, <span class="refTitle">"DNS over Datagram Transport Layer Security (DTLS)"</span>, <span class="seriesInfo">RFC 8094</span>, <span class="seriesInfo">DOI 10.17487/RFC8094</span>, <time datetime="2017-02" class="refDate">February 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8094">https://www.rfc-editor.org/rfc/rfc8094</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8484">[RFC8484]</dt>
        <dd>
<span class="refAuthor">Hoffman, P.</span> and <span class="refAuthor">P. McManus</span>, <span class="refTitle">"DNS Queries over HTTPS (DoH)"</span>, <span class="seriesInfo">RFC 8484</span>, <span class="seriesInfo">DOI 10.17487/RFC8484</span>, <time datetime="2018-10" class="refDate">October 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8484">https://www.rfc-editor.org/rfc/rfc8484</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8701">[RFC8701]</dt>
        <dd>
<span class="refAuthor">Benjamin, D.</span>, <span class="refTitle">"Applying Generate Random Extensions And Sustain Extensibility (GREASE) to TLS Extensibility"</span>, <span class="seriesInfo">RFC 8701</span>, <span class="seriesInfo">DOI 10.17487/RFC8701</span>, <time datetime="2020-01" class="refDate">January 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8701">https://www.rfc-editor.org/rfc/rfc8701</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8744">[RFC8744]</dt>
        <dd>
<span class="refAuthor">Huitema, C.</span>, <span class="refTitle">"Issues and Requirements for Server Name Identification (SNI) Encryption in TLS"</span>, <span class="seriesInfo">RFC 8744</span>, <span class="seriesInfo">DOI 10.17487/RFC8744</span>, <time datetime="2020-07" class="refDate">July 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8744">https://www.rfc-editor.org/rfc/rfc8744</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="WHATWG-IPV4">[WHATWG-IPV4]</dt>
      <dd>
<span class="refTitle">"URL Living Standard - IPv4 Parser"</span>, <time datetime="2021-05" class="refDate">May 2021</time>, <span>&lt;<a href="https://url.spec.whatwg.org/#concept-ipv4-parser">https://url.spec.whatwg.org/#concept-ipv4-parser</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="config-extensions-guidance">
<section id="appendix-A">
      <h2 id="name-echconfig-extension-guidanc">
<a href="#appendix-A" class="section-number selfRef">Appendix A. </a><a href="#name-echconfig-extension-guidanc" class="section-name selfRef">ECHConfig Extension Guidance</a>
      </h2>
<p id="appendix-A-1">Any future information or hints that influence ClientHelloOuter SHOULD be
specified as ECHConfig extensions. This is primarily because the outer
ClientHello exists only in support of ECH. Namely, it is both an envelope for
the encrypted inner ClientHello and enabler for authenticated key mismatch
signals (see <a href="#server-behavior" class="auto internal xref">Section 7</a>). In contrast, the inner ClientHello is the
true ClientHello used upon ECH negotiation.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="linear-outer-extensions">
<section id="appendix-B">
      <h2 id="name-linear-time-outer-extension">
<a href="#appendix-B" class="section-number selfRef">Appendix B. </a><a href="#name-linear-time-outer-extension" class="section-name selfRef">Linear-time Outer Extension Processing</a>
      </h2>
<p id="appendix-B-1">The following procedure processes the "ech_outer_extensions" extension (see
<a href="#encoding-inner" class="auto internal xref">Section 5.1</a>) in linear time, ensuring that each referenced extension
in the ClientHelloOuter is included at most once:<a href="#appendix-B-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="appendix-B-2">
<li id="appendix-B-2.1">
          <p id="appendix-B-2.1.1">Let I be initialized to zero and N be set to the number of extensions
in ClientHelloOuter.<a href="#appendix-B-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="appendix-B-2.2">
          <p id="appendix-B-2.2.1">For each extension type, E, in OuterExtensions:<a href="#appendix-B-2.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-B-2.2.2.1">
              <p id="appendix-B-2.2.2.1.1">If E is "encrypted_client_hello", abort the connection with an
"illegal_parameter" alert and terminate this procedure.<a href="#appendix-B-2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="appendix-B-2.2.2.2">
              <p id="appendix-B-2.2.2.2.1">While I is less than N and the I-th extension of
ClientHelloOuter does not have type E, increment I.<a href="#appendix-B-2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="appendix-B-2.2.2.3">
              <p id="appendix-B-2.2.2.3.1">If I is equal to N, abort the connection with an "illegal_parameter"
alert and terminate this procedure.<a href="#appendix-B-2.2.2.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="appendix-B-2.2.2.4">
              <p id="appendix-B-2.2.2.4.1">Otherwise, the I-th extension of ClientHelloOuter has type E. Copy
it to the EncodedClientHelloInner and increment I.<a href="#appendix-B-2.2.2.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</li>
      </ol>
</section>
</div>
<div id="acknowledgements">
<section id="appendix-C">
      <h2 id="name-acknowledgements">
<a href="#appendix-C" class="section-number selfRef">Appendix C. </a><a href="#name-acknowledgements" class="section-name selfRef">Acknowledgements</a>
      </h2>
<p id="appendix-C-1">This document draws extensively from ideas in <span>[<a href="#I-D.kazuho-protected-sni" class="cite xref">I-D.kazuho-protected-sni</a>]</span>, but
is a much more limited mechanism because it depends on the DNS for the
protection of the ECH key. Richard Barnes, Christian Huitema, Patrick McManus,
Matthew Prince, Nick Sullivan, Martin Thomson, and David Benjamin also provided
important ideas and contributions.<a href="#appendix-C-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="change-log">
<section id="appendix-D">
      <h2 id="name-change-log">
<a href="#appendix-D" class="section-number selfRef">Appendix D. </a><a href="#name-change-log" class="section-name selfRef">Change Log</a>
      </h2>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="appendix-D-1.1">
          <p id="appendix-D-1.1.1"><strong>RFC Editor's Note:</strong> Please remove this section prior to publication of a
final version of this document.<a href="#appendix-D-1.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="appendix-D-2">Issue and pull request numbers are listed with a leading octothorp.<a href="#appendix-D-2" class="pilcrow">¶</a></p>
<div id="since-draft-ietf-tls-esni-16">
<section id="appendix-D.1">
        <h3 id="name-since-draft-ietf-tls-esni-1">
<a href="#appendix-D.1" class="section-number selfRef">D.1. </a><a href="#name-since-draft-ietf-tls-esni-1" class="section-name selfRef">Since draft-ietf-tls-esni-16</a>
        </h3>
<ul class="normal">
<li class="normal" id="appendix-D.1-1.1">
            <p id="appendix-D.1-1.1.1">Keep-alive<a href="#appendix-D.1-1.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="since-draft-ietf-tls-esni-15">
<section id="appendix-D.2">
        <h3 id="name-since-draft-ietf-tls-esni-15">
<a href="#appendix-D.2" class="section-number selfRef">D.2. </a><a href="#name-since-draft-ietf-tls-esni-15" class="section-name selfRef">Since draft-ietf-tls-esni-15</a>
        </h3>
<ul class="normal">
<li class="normal" id="appendix-D.2-1.1">
            <p id="appendix-D.2-1.1.1">Add CCS2022 reference and summary (#539)<a href="#appendix-D.2-1.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="since-draft-ietf-tls-esni-14">
<section id="appendix-D.3">
        <h3 id="name-since-draft-ietf-tls-esni-14">
<a href="#appendix-D.3" class="section-number selfRef">D.3. </a><a href="#name-since-draft-ietf-tls-esni-14" class="section-name selfRef">Since draft-ietf-tls-esni-14</a>
        </h3>
<ul class="normal">
<li class="normal" id="appendix-D.3-1.1">
            <p id="appendix-D.3-1.1.1">Keep-alive<a href="#appendix-D.3-1.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="since-draft-ietf-tls-esni-13">
<section id="appendix-D.4">
        <h3 id="name-since-draft-ietf-tls-esni-13">
<a href="#appendix-D.4" class="section-number selfRef">D.4. </a><a href="#name-since-draft-ietf-tls-esni-13" class="section-name selfRef">Since draft-ietf-tls-esni-13</a>
        </h3>
<ul class="normal">
<li class="normal" id="appendix-D.4-1.1">
            <p id="appendix-D.4-1.1.1">Editorial improvements<a href="#appendix-D.4-1.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="since-draft-ietf-tls-esni-12">
<section id="appendix-D.5">
        <h3 id="name-since-draft-ietf-tls-esni-12">
<a href="#appendix-D.5" class="section-number selfRef">D.5. </a><a href="#name-since-draft-ietf-tls-esni-12" class="section-name selfRef">Since draft-ietf-tls-esni-12</a>
        </h3>
<ul class="normal">
<li class="normal" id="appendix-D.5-1.1">
            <p id="appendix-D.5-1.1.1">Abort on duplicate OuterExtensions (#514)<a href="#appendix-D.5-1.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.5-1.2">
            <p id="appendix-D.5-1.2.1">Improve EncodedClientHelloInner definition (#503)<a href="#appendix-D.5-1.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.5-1.3">
            <p id="appendix-D.5-1.3.1">Clarify retry configuration usage (#498)<a href="#appendix-D.5-1.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.5-1.4">
            <p id="appendix-D.5-1.4.1">Expand on config_id generation implications (#491)<a href="#appendix-D.5-1.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.5-1.5">
            <p id="appendix-D.5-1.5.1">Server-side acceptance signal extension GREASE (#481)<a href="#appendix-D.5-1.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.5-1.6">
            <p id="appendix-D.5-1.6.1">Refactor overview, client implementation, and middlebox
sections (#480, #478, #475, #508)<a href="#appendix-D.5-1.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.5-1.7">
            <p id="appendix-D.5-1.7.1">Editorial iprovements (#485, #488, #490, #495, #496, #499, #500,
#501, #504, #505, #507, #510, #511)<a href="#appendix-D.5-1.7.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="since-draft-ietf-tls-esni-11">
<section id="appendix-D.6">
        <h3 id="name-since-draft-ietf-tls-esni-11">
<a href="#appendix-D.6" class="section-number selfRef">D.6. </a><a href="#name-since-draft-ietf-tls-esni-11" class="section-name selfRef">Since draft-ietf-tls-esni-11</a>
        </h3>
<ul class="normal">
<li class="normal" id="appendix-D.6-1.1">
            <p id="appendix-D.6-1.1.1">Move ClientHello padding to the encoding (#443)<a href="#appendix-D.6-1.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.6-1.2">
            <p id="appendix-D.6-1.2.1">Align codepoints (#464)<a href="#appendix-D.6-1.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.6-1.3">
            <p id="appendix-D.6-1.3.1">Relax OuterExtensions checks for alignment with RFC8446 (#467)<a href="#appendix-D.6-1.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.6-1.4">
            <p id="appendix-D.6-1.4.1">Clarify HRR acceptance and rejection logic (#470)<a href="#appendix-D.6-1.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.6-1.5">
            <p id="appendix-D.6-1.5.1">Editorial improvements (#468, #465, #462, #461)<a href="#appendix-D.6-1.5.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="since-draft-ietf-tls-esni-10">
<section id="appendix-D.7">
        <h3 id="name-since-draft-ietf-tls-esni-10">
<a href="#appendix-D.7" class="section-number selfRef">D.7. </a><a href="#name-since-draft-ietf-tls-esni-10" class="section-name selfRef">Since draft-ietf-tls-esni-10</a>
        </h3>
<ul class="normal">
<li class="normal" id="appendix-D.7-1.1">
            <p id="appendix-D.7-1.1.1">Make HRR confirmation and ECH acceptance explicit (#422, #423)<a href="#appendix-D.7-1.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.2">
            <p id="appendix-D.7-1.2.1">Relax computation of the acceptance signal (#420, #449)<a href="#appendix-D.7-1.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.3">
            <p id="appendix-D.7-1.3.1">Simplify ClientHelloOuterAAD generation (#438, #442)<a href="#appendix-D.7-1.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.4">
            <p id="appendix-D.7-1.4.1">Allow empty enc in ECHClientHello (#444)<a href="#appendix-D.7-1.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.5">
            <p id="appendix-D.7-1.5.1">Authenticate ECHClientHello extensions position in ClientHelloOuterAAD (#410)<a href="#appendix-D.7-1.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.6">
            <p id="appendix-D.7-1.6.1">Allow clients to send a dummy PSK and early_data in ClientHelloOuter when
applicable (#414, #415)<a href="#appendix-D.7-1.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.7">
            <p id="appendix-D.7-1.7.1">Compress ECHConfigContents (#409)<a href="#appendix-D.7-1.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.8">
            <p id="appendix-D.7-1.8.1">Validate ECHConfig.contents.public_name (#413, #456)<a href="#appendix-D.7-1.8.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.9">
            <p id="appendix-D.7-1.9.1">Validate ClientHelloInner contents (#411)<a href="#appendix-D.7-1.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.10">
            <p id="appendix-D.7-1.10.1">Note split-mode challenges for HRR (#418)<a href="#appendix-D.7-1.10.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.7-1.11">
            <p id="appendix-D.7-1.11.1">Editorial improvements (#428, #432, #439, #445, #458, #455)<a href="#appendix-D.7-1.11.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="since-draft-ietf-tls-esni-09">
<section id="appendix-D.8">
        <h3 id="name-since-draft-ietf-tls-esni-0">
<a href="#appendix-D.8" class="section-number selfRef">D.8. </a><a href="#name-since-draft-ietf-tls-esni-0" class="section-name selfRef">Since draft-ietf-tls-esni-09</a>
        </h3>
<ul class="normal">
<li class="normal" id="appendix-D.8-1.1">
            <p id="appendix-D.8-1.1.1">Finalize HPKE dependency (#390)<a href="#appendix-D.8-1.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.8-1.2">
            <p id="appendix-D.8-1.2.1">Move from client-computed to server-chosen, one-byte config
identifier (#376, #381)<a href="#appendix-D.8-1.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.8-1.3">
            <p id="appendix-D.8-1.3.1">Rename ECHConfigs to ECHConfigList (#391)<a href="#appendix-D.8-1.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-D.8-1.4">
            <p id="appendix-D.8-1.4.1">Clarify some security and privacy properties (#385, #383)<a href="#appendix-D.8-1.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-E">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Eric Rescorla</span></div>
<div dir="auto" class="left"><span class="org">Independent</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ekr@rtfm.com" class="email">ekr@rtfm.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Kazuho Oku</span></div>
<div dir="auto" class="left"><span class="org">Fastly</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:kazuhooku@gmail.com" class="email">kazuhooku@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Nick Sullivan</span></div>
<div dir="auto" class="left"><span class="org">Cryptography Consulting LLC</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:nicholas.sullivan+ietf@gmail.com" class="email">nicholas.sullivan+ietf@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christopher A. Wood</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:caw@heapingbits.net" class="email">caw@heapingbits.net</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
